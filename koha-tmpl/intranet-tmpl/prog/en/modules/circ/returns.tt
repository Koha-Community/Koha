[% USE raw %]
[% USE Asset %]
[% USE KohaDates %]
[% USE Branches %]
[% USE Koha %]
[% USE ItemTypes %]
[% USE AuthorisedValues %]
[% USE TablesSettings %]
[% PROCESS 'i18n.inc' %]
[% PROCESS 'member-display-address-style.inc' %]
[% PROCESS 'html_helpers.inc' %]
[% SET footerjs = 1 %]
[% BLOCK display_bormessagepref %]
    [% IF ( bormessagepref ) %]
        <li class="notification_method"
            ><span>Patron notification:</span>
            [% FOREACH mtt IN bormessagepref.keys %]
                [%~ IF ( mtt == 'email' ) %]<span>Email</span>[% END ~%]
                [%~ IF ( mtt == 'phone' ) %]<span>Phone</span>[% END ~%]
                [%~ IF ( mtt == 'sms' ) %]<span>SMS</span>[% END ~%]
                [%~ UNLESS loop.last %],[% ELSE %].[% END ~%]
            [% END %]
        </li>
    [% ELSE %]
        <li class="notification_method none">Patron is not notified.</li>
    [% END %]
[% END %]

[% BLOCK display_holdpatron_address %]
    [% PROCESS 'display-address-style' %]
[% END %]

[% INCLUDE 'doc-head-open.inc' %]
<title
    >[% FILTER collapse %]
        [% tx("Check in {title}", { title = title }) | html %]
        &rsaquo; [% t("Circulation") | html %] &rsaquo; [% t("Koha") | html %]
    [% END %]</title
>
[% INCLUDE 'doc-head-close.inc' %]
</head>

<body id="circ_returns" class="circ">
<span class="audio-alert-success"></span>

[% WRAPPER 'header.inc' %]
    [% INCLUDE 'checkin-search.inc' %]
[% END %]

[% WRAPPER 'sub-header.inc' %]
    [% WRAPPER breadcrumbs %]
        [% WRAPPER breadcrumb_item %]
            <a href="/cgi-bin/koha/circ/circulation-home.pl">Circulation</a>
        [% END %]
        [% WRAPPER breadcrumb_item bc_active= 1 %]
            <span>Check in</span>
        [% END %]
    [% END #/ WRAPPER breadcrumbs %]
[% END #/ WRAPPER sub-header.inc %]

[% SET aside = Koha.Preference('CircSidebar') ? 'circ-nav' : '' %]
[% WRAPPER 'main-container.inc' aside=aside %]

    [% BLOCK all_checkin_messages %]
        [% IF hold_auto_filled %]
            <div class="alert alert-info hold-auto-filled">
                [% IF ( reservenotes ) %]
                    <h4>Notes: [% reservenotes | html %]</h4>
                [% END %]
                <h3>Hold filled for:</h3>
                <ul>
                    <li>
                        [% INCLUDE 'patron-title.inc' patron=patron hide_patron_infos_if_needed=1 invert_name=1 %]
                        <span class="patron-category"> - [% patron.category.description | html %]</span>
                    </li>

                    [% INCLUDE display_holdpatron_address %]

                    [% IF ( patron.phone ) %]
                        <li>[% patron.phone | html %]</li>
                    [% END %]

                    [% IF ( patron.email ) %]
                        <li>
                            [% IF ( transfertodo ) %]
                                [% patron.email | html %]
                            [% ELSE %]
                                <a id="boremail" href="mailto:[% patron.email | html %]">[% patron.email | html %]</a>
                            [% END %]
                        </li>
                    [% END %]

                    [% UNLESS ( transfertodo) %]
                        [% INCLUDE display_bormessagepref %]
                    [% END %]

                    [% IF ( patron.is_debarred ) %]
                        <li class="error">Patron is RESTRICTED</li>
                    [% END %]

                    [% IF ( patron.gonenoaddress ) %]
                        <li class="error">Patron's address is in doubt</li>
                    [% END %]
                </ul>

                [% IF ( transfertodo ) %]
                    <h4><strong>Transfer to:</strong> [% Branches.GetName( destbranch ) | html %]</h4>
                [% ELSE %]
                    <h4><strong>Hold at</strong> [% Branches.GetName( destbranch ) | html %]</h4>
                [% END %]

                <a href="#" class="btn btn-default print print-slip"> <i class="fa fa-print"></i> Print </a>
            </div>
            <!-- /.hold-auto-filled -->
        [% END # /IF hold_auto_filled %]

        [% IF ( trigger && !transfertodo ) %]
            <div id="transfer-trigger" class="alert alert-info">
                <h3>Reason for transfer</h3>
                <p>
                    [%- SWITCH trigger -%]

                    [%- CASE 'Manual' -%]
                        <span>Manual</span>
                    [%- CASE 'StockrotationAdvance' -%]
                        <span>Stock rotation advance</span>
                    [%- CASE 'StockrotationRepatriation' -%]
                        <span>Stock rotation repatriation</span>
                    [%- CASE 'ReturnToHome' -%]
                        <span>Return to home library</span>
                    [%- CASE 'ReturnToHolding' -%]
                        <span>Return to holding library</span>
                    [%- CASE 'RotatingCollection' -%]
                        <span>Rotating collection</span>
                    [%- CASE 'Reserve' -%]
                        <span>Hold</span>
                    [%- CASE 'LostReserve' -%]
                        <span>Lost hold</span>
                    [%- CASE 'CancelReserve' -%]
                        <span>Cancelled hold</span>
                    [%- CASE 'TransferCancellation' -%]
                        <span>Transfer was cancelled whilst in transit</span>
                    [%- CASE 'Recall' -%]
                        <span>Recall</span>
                    [%- CASE 'RecallCancellation' -%]
                        <span>Cancelled recall</span>
                    [%- END -%]
                </p>
            </div>
        [% END %]

        [% IF privacy == 2 AND NOT Koha.Preference('AnonymousPatron') %]
            <div class="alert alert-warning">
                <strong>Error:</strong>
                This patron has requested their circulation history be anonymized on check-in, but the AnonymousPatron system preference is empty or incorrect.
            </div>
        [% ELSIF NOT Koha.Preference('AnonymousPatron') AND Koha.Preference('OPACPrivacy') %]
            <div class="alert alert-warning">
                <strong>Error:</strong>
                The system preference OPACPrivacy is set but AnonymousPatron is not! Please correct this before continuing circulation.
            </div>
        [% END %]

        [% IF additional_materials && !needs_confirm && !multiple_confirmed %]
            <div id="materials" class="alert alert-info">
                <span class="mats_spec_label">Note about the accompanying materials: </span>
                <span class="mats_spec_message">[% additional_materials | html %]</span>
            </div>
        [% END %]

        [% IF ( collectionItemNeedsTransferred ) %]
            <div id="rotating-collection" class="alert alert-info">
                <h3>Please transfer item to: [% Branches.GetName( collectionBranch ) | html %]</h3>
                <p><a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]">[% item.barcode | html %]: [% title | html %]</a></p>
                <p>This item is part of a rotating collection.</p>
                <p
                    ><button type="button" class="openWin" data-url="transfer-slip.pl?transferitem=[% itemnumber | uri %]&amp;branchcode=[% collectionBranch | uri %]&amp;op=slip"><i class="fa fa-print"></i> Print slip</button></p
                >
            </div>
        [% END %]

        <!-- Patron has added an issue note -->
        [% IF ( issue.note) %]
            <div class="alert alert-info issue-note">
                <h1>Patron note</h1>
                <p>[% issue.notedate | $KohaDates %]</p>
                <p><a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% itembiblionumber | uri %]"> [% title | html %]</a> [% author | html %]</p>
                <p>[% issue.note | html %]</p>
            </div>
        [% END %]

        <!-- Patron has fines -->
        [% IF ( fines ) %]
            <div class="alert alert-warning patron-fines">
                <h3>Patron has outstanding fines of [% fines | html %].</h3>
                <p><a href="/cgi-bin/koha/members/pay.pl?borrowernumber=[% fineborrowernumber | uri %]">Make payment</a>.</p>
            </div>
        [% END %]

        <!-- Item has return claim(s) -->
        [% IF ( ClaimAutoResolved ) %]
            <div class="alert alert-warning resolved-claim">
                <p><strong>The previously claimed returned item has been found, automatically resolving the associated claim.</strong></p>
            </div>
        [% ELSIF( ReturnClaims ) %]
            <div class="alert alert-warning return-claim">
                <h3>This item has been claimed as returned by:</h3>
                <ul>
                    [% FOREACH rc IN ReturnClaims %]
                        <li>
                            [% INCLUDE 'patron-title.inc' patron=rc.patron hide_patron_infos_if_needed=1 invert_name=1 %]
                            <a class="btn btn-default btn-xs return-claim-tools-resolve" role="button" data-return-claim-id="[% rc.id | html %]" data-current-lost-status="0"><i class="fa fa-check-square"></i> Resolve</a>
                        </li>
                    [% END %]
                </ul>
            </div>
        [% END %]

        <!-- Patron has waiting holds -->
        [% IF ( waiting_holds ) %]
            <div id="awaiting-pickup" class="alert alert-info">
                <h3>[% INCLUDE 'patron-title.inc' patron=issue.patron hide_patron_infos_if_needed=1 invert_name=1 %] has [% waiting_holds | html %] hold(s) waiting for pickup.</h3>
                <p><a href="/cgi-bin/koha/circ/circulation.pl?borrowernumber=[% holdsborrowernumber | uri %]">Check out to this patron</a>.</p>
            </div>
        [% END %]

        <!-- Patron is restricted and checkin was backdated -->
        [% IF return_date_was_overriden && issue.patron.is_debarred %]
            <div id="restricted_backdated" class="alert alert-info">
                <h3> [% INCLUDE 'patron-title.inc' patron=issue.patron hide_patron_infos_if_needed=1 invert_name=1 %] is restricted. Please verify this patron should still be restricted. </h3>
            </div>
        [% END %]

        <!-- Bundle has items missing -->
        [% IF missing_items %]
            <div id="bundle_missing_items" class="alert alert-warning">
                <h3>Bundle had missing items</h3>
                <p>Bundle contents list updated</p>
                <p>
                    <a class="btn btn-default btn-xs" role="button" data-bs-toggle="modal" href="#bundleContentsModal"><i class="fa-solid fa-eye" aria-hidden="true"></i> View updated contents list</a>
                    <a class="btn btn-default btn-xs" role="button" data-bs-toggle="modal" href="#bundleMissingModal"><i class="fa-solid fa-eye" aria-hidden="true"></i> View list of missing items</a>
                </p>
            </div>
        [% END %]

        <!-- Bundle contained unexpected items -->
        [% IF unexpected_items %]
            <div id="bundle_unexpected_items" class="alert alert-warning">
                <h3>Bundle had unexpected items</h3>
                <p>Please place the following items to one side</p>
                <ul>
                    [% FOREACH unexpected_item IN unexpected_items %]
                        <li>[% INCLUDE 'biblio-title.inc' biblio=unexpected_item.biblio %] - [% unexpected_item.barcode | html %]</li>
                    [% END %]
                </ul>
            </div>
        [% END %]

        <!-- Item checked in outside of bundle -->
        [% IF InBundle %]
            <div id="bundle_item_outside" class="alert alert-warning audio-alert-warning">
                <h3>Item belongs in bundle</h3>
                <p>This item belongs to a bundle: [% INCLUDE 'biblio-title.inc' biblio=InBundle.biblio %] - [% InBundle.barcode | html %]</p>
                <p
                    ><button class="btn btn-default btn-xs bundle_remove" role="button" data-itemnumber="[% itemnumber | uri %]" data-hostnumber="[% InBundle.itemnumber | uri %]"><i class="fa fa-minus"></i> Remove from bundle</button></p
                >
            </div>
        [% END %]

        [% IF ( errmsgloop ) %]
            <div class="alert alert-warning audio-alert-warning">
                <h3>Check in message</h3>
                [% IF itembiblionumber %]
                    <p><a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]">[% item.barcode | html %]: [% title | html %]</a></p>
                [% END %]
                [% FOREACH errmsgloo IN errmsgloop %]
                    [% IF ( errmsgloo.NotForLoanStatusUpdated ) %]
                        <p class="problem ret_nflupdate">
                            [% IF errmsgloo.NotForLoanStatusUpdated.to == 'ONLYMESSAGE' %]
                                [% AuthorisedValues.GetByCode( 'NOT_LOAN', errmsgloo.NotForLoanStatusUpdated.from ) | html %]
                            [% ELSE %]
                                Not for loan status updated.
                                <br />Old value:
                                [% IF errmsgloo.NotForLoanStatusUpdated.from %]
                                    <span class="ret_updatedfrom"> [% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.notforloan', authorised_value => errmsgloo.NotForLoanStatusUpdated.from ) | html %]. </span>
                                [% ELSE %]
                                    Available for loan.
                                [% END %] <br />New value:
                                [% IF errmsgloo.NotForLoanStatusUpdated.to %]
                                    <span class="ret_updatedto"> [% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.notforloan', authorised_value => errmsgloo.NotForLoanStatusUpdated.to ) | html %]. </span>
                                [% ELSE %]
                                    Available for loan.
                                [% END %]
                            [% END %]
                        </p>
                    [% END %]
                    [% IF ( errmsgloo.UpdateLastSeenError ) %]
                        <div id="update_last_seen_error" class="alert alert-warning audio-alert-warning">
                            <h3>Error updating patron's last seen date</h3>
                            <p>The item has been checked in, but the issue below must be corrected:</p>
                            <p>The system encountered an error when updating the patron's last seen date:</p>
                            <p>[% errmsgloo.UpdateLastSeenError | html %]</p>
                        </div>
                    [% END %]
                    [% IF ( errmsgloo.ItemLocationUpdated ) %]
                        <p class="problem ret_location_update">
                            Item shelving location updated.
                            <br /><span>Old value:</span>
                            [% IF errmsgloo.ItemLocationUpdated.from %]
                                [% SET av_description = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.location', authorised_value => errmsgloo.ItemLocationUpdated.from ) %]
                                [% IF errmsgloo.ItemLocationUpdated.from == '' %]
                                    <span>empty</span>
                                [% ELSIF av_description == '' %]
                                    [% errmsgloo.ItemLocationUpdated.from | html %]
                                    (<span>No description available</span>)
                                [% ELSE %]
                                    [% av_description | html %]
                                [% END %]
                            [% ELSE %]
                                <span>"Blank"</span>
                            [% END %]
                            <br />New value:
                            [% IF errmsgloo.ItemLocationUpdated.to %]
                                [% SET av_description = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.location', authorised_value => errmsgloo.ItemLocationUpdated.to ) %]
                                [% IF errmsgloo.ItemLocationUpdated.to == '' %]
                                    empty
                                [% ELSIF av_description == '' %]
                                    [% errmsgloo.ItemLocationUpdated.to | html %]
                                    (Not an authorized value)
                                [% ELSE %]
                                    [% av_description | html %]
                                [% END %]
                            [% ELSE %]
                                "Blank"
                            [% END %]
                        </p>
                    [% END %]
                    [% IF ( errmsgloo.badbarcode ) %]
                        <p class="problem ret_badbarcode">No item with barcode: [% errmsgloo.msg | html %]</p>
                    [% END %]
                    [% IF ( errmsgloo.notissued ) %]
                        <p class="problem ret_notissued">Not checked out.</p>
                    [% END %]
                    [% IF ( errmsgloo.localuse) %]
                        <p class="problem ret_localuse">Local use recorded</p>
                    [% END %]
                    [% IF ( errmsgloo.transferred ) %]
                        <p class="problem ret_transferred">Item received from [% Branches.GetName( errmsgloo.transferred ) | html %]</p>
                    [% END %]
                    [% IF ( errmsgloo.waslost ) %]
                        [% IF Koha.Preference('BlockReturnOfLostItems') %]
                            <p class="problem ret_blocked">Item is lost, cannot be checked in.</p>
                        [% ELSE %]
                            [% itemlost_description = AuthorisedValues.GetDescriptionByKohaField({ kohafield => 'items.itemlost', authorised_value => item.itemlost }) %]
                            <p class="problem ret_checkedin">Item was [% itemlost_description | html %], now found.</p>
                        [% END %]
                        [% IF LostItemFeeRefunded and not Koha.Preference('BlockReturnOfLostItems') %]
                            <p class="problem ret_refund">A refund for the lost item charge has been applied to the borrowing patron's account.</p>
                        [% ELSIF LostItemFeeCharged and not Koha.Preference('BlockReturnOfLostItems') %]
                            <p class="problem ret_charged">A refund for the lost item charge has been applied to the borrowing patron's account, and new overdue charge has been calculated and applied.</p>
                        [% ELSIF LostItemFeeRestored and not Koha.Preference('BlockReturnOfLostItems') %]
                            <p class="problem ret_restored">A refund for the lost item charge has been applied to the borrowing patron's account and if an overdue fine was forgiven when the item was marked as lost, it has been reverted.</p>
                        [% ELSIF LostItemPaymentNotRefunded and not Koha.Preference('BlockReturnOfLostItems') %]
                            <p class="problem ret_restored"
                                >No refund was applied to the patron's account for the previously paid lost item charge as the payment was made more than [% Koha.Preference('NoRefundOnLostFinesPaidAge') | html %] days ago.</p
                            >
                        [% ELSIF Koha.Preference('BlockReturnOfLostItems') %]
                            <h5>Cannot check in</h5>
                            <p><strong>NOT CHECKED IN</strong></p>
                        [% ELSE %]
                            <p class="problem ret_feeremains">Any lost item fees for this item will remain on the patron's account.</p>
                        [% END %]
                        [% IF ProcessingFeeRefunded and not Koha.Preference('BlockReturnOfLostItems') %]
                            <p class="problem ret_refund">A refund for the lost item processing charge has been applied to the borrowing patron's account.</p>
                        [% ELSE %]
                            <p class="problem ret_feeremains">Any processing fees for this item will remain on the patron's account.</p>
                        [% END %]
                    [% END %]
                    [% IF ( errmsgloo.withdrawn ) %]
                        [% IF Koha.Preference('BlockReturnOfWithdrawnItems') %]
                            <h5>Cannot check in</h5>
                            <p><strong>NOT CHECKED IN</strong></p>
                        [% END %]
                        <p class="problem ret_withdrawn">
                            <span>Item has been withdrawn</span>
                            [% item_withdrawn_lib = AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.withdrawn', authorised_value => item.withdrawn ) %]
                            [% IF (item_withdrawn_lib) %]<span class="ci-withdrawn">([% item_withdrawn_lib | html %])</span>[% END %]
                        </p>
                    [% END %]
                    [% IF ( errmsgloo.debarred ) %]
                        <p class="problem ret_debarred"
                            ><a href="/cgi-bin/koha/circ/circulation.pl?borrowernumber=[% errmsgloo.debarborrowernumber | uri %]">[% errmsgloo.debarname | html %]([% errmsgloo.debarcardnumber | html %])</a> is now debarred until
                            [% errmsgloo.debarred | $KohaDates %].</p
                        >
                    [% END %]
                    [% IF ( errmsgloo.prevdebarred ) %]
                        <p class="problem ret_prevdebarred"><strong>Reminder: </strong>Patron was earlier restricted until [% errmsgloo.prevdebarred | $KohaDates %].</p>
                    [% END %]
                    [% IF ( errmsgloo.foreverdebarred ) %]
                        <p class="problem ret_foreverdebarred"><strong>Reminder: </strong>Patron has an indefinite restriction.</p>
                    [% END %]
                    [% IF ( errmsgloo.data_corrupted ) %]
                        <p class="problem ret_datacorrupt">
                            The item has not been checked in due to an issue in your system. Note the error below. An administrator may find further details by looking at the <a href="/cgi-bin/koha/about.pl?tab=sysinfo">about page</a> and
                            correcting errors shown on the "System information" tab, or note the error below.
                        </p>
                        <p class="problem ret_error_message"> Error: ([% errmsgloo.data_corrupted | html %]) </p>
                    [% END %]
                [% END # /FOREACH errmsgloo %]
            </div>
            <!-- /.dialog.dialog-alert -->
        [% END #/IF errmsgloop %]

        [% IF ( checkinmsg ) %]
            [% IF ( checkinmsgtype == 'alert' ) %]
                [% SET div_class='warning' %]
            [% ELSE %]
                [% SET div_class='info' %]
            [% END %]
            <div class="alert alert-[% div_class | html %]">
                <p class="ret_checkinmsg">[% checkinmsg | html_line_break %]</p>
            </div>
        [% END # /IF checkinmsg %]

        [% IF bundle_items && !missing_items %]
            <div class="alert alert-info">
                <h3>Bundle verified</h3>
                <p>The bundle content was verified</p>
                <p
                    ><a class="btn btn-default btn-xs" role="button" data-bs-toggle="modal" href="#bundleContentsModal"><i class="fa-solid fa-eye" aria-hidden="true"></i> View contents list</a></p
                >
            </div>
        [% END %]
    [% END # /BLOCK all_checkin_messages %]

    [% IF needs_confirm %]
        <div id="circ-needsconfirmation-modal" class="modal modal-lg block audio-alert-action" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title">Please confirm checkin</h1>
                    </div>
                    <div class="modal-body">
                        <ul>
                            <li>
                                <span class="mats_spec_label">Please confirm that the accompanying materials are present: </span>
                                <span class="mats_spec_message">[% additional_materials | html %]</span>
                            </li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <form method="post" action="/cgi-bin/koha/circ/returns.pl" autocomplete="off">
                            [% INCLUDE 'csrf-token.inc' %]
                            <input type="hidden" name="op" value="cud-checkin" />
                            <input type="hidden" name="barcode" value="[% item.barcode | html %]" />
                            <input type="hidden" name="return_date_override" value="[% return_date_override | html %]" />
                            <input type="hidden" name="return_date_override_remember" value="[% return_date_override_remember | html %]" />
                            <input type="hidden" name="multiple_confirm" value="1" />
                            <input type="hidden" name="dropboxmode" value="[% dropboxmode | html %]" />
                            <input type="hidden" name="exemptfine" value="[% exemptfine | html %]" />
                            [% FOREACH checkin IN checkins %]
                                <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
                                <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
                                <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
                                <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
                                <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
                            [% END %]
                            <button type="submit" class="btn btn-default approve" accesskey="y"><i class="fa fa-check"></i> Yes, checkin (Y)</button>
                        </form>
                        <button type="button" data-bs-dismiss="modal" class="btn btn-default deny" accesskey="n"><i class="fa fa-times"></i> No, don't checkin (N)</button>
                    </div>
                </div>
            </div>
        </div>
    [% END %]

    [% IF items_bundle_return_confirmation %]
        <div id="bundle-needsconfirmation-modal" class="modal modal-lg block audio-alert-action" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <form method="post">
                        [% INCLUDE 'csrf-token.inc' %]
                        <div class="modal-header">
                            <h1 class="modal-title">Please confirm bundle contents for [% item.barcode | html %]</h1>
                        </div>
                        <div class="modal-body">
                            <table class="table table-condensed table-bordered" id="items-bundle-contents-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Item type</th>
                                        <th>Barcode</th>
                                        [% IF !item.onloan %]
                                            <th>Status</th>
                                        [% END %]
                                    </tr>
                                </thead>
                                <tbody>
                                    [% FOREACH bundle_item IN item.bundle_items %]
                                        [% IF !item.onloan %]
                                            <tr data-barcode="[% bundle_item.barcode | html %]">
                                                <td>[% INCLUDE 'biblio-title.inc' biblio=bundle_item.biblio link = 1 %]</td>
                                                <td>[% bundle_item.biblio.author | html %]</td>
                                                <td>[% ItemTypes.GetDescription(bundle_item.itype) | html %]</td>
                                                <td>[% bundle_item.barcode | html %]</td>
                                                <td>
                                                    [% IF bundle_item.itemlost %]
                                                        [% itemlost_description = AuthorisedValues.GetDescriptionByKohaField({ kohafield = 'items.itemlost', authorised_value = bundle_item.itemlost }) %]
                                                        <span class="lost">[% itemlost_description | html %]</span>
                                                    [% ELSE %]
                                                        Present
                                                    [% END %]
                                                </td>
                                            </tr>
                                        [% ELSIF !bundle_item.itemlost %]
                                            <tr data-barcode="[% bundle_item.barcode | html %]">
                                                <td>[% INCLUDE 'biblio-title.inc' biblio=bundle_item.biblio link = 1 %]</td>
                                                <td>[% bundle_item.biblio.author | html %]</td>
                                                <td>[% ItemTypes.GetDescription(bundle_item.itype) | html %]</td>
                                                <td>[% bundle_item.barcode | html %]</td>
                                            </tr>
                                        [% END %]
                                    [% END %]
                                </tbody>
                            </table>

                            <div class="form-group">
                                <label for="verify-items-bundle-contents-barcodes"
                                    >Barcodes <span id="verify-progress" style="display: none"><span id="verified">0</span> of <span id="expected"></span> verified</span></label
                                >
                                <textarea autocomplete="off" id="verify-items-bundle-contents-barcodes" name="verify-items-bundle-contents-barcodes" class="form-control"></textarea>
                                [% IF item.onloan %]
                                    <div class="help-block">Scan all barcodes of items found in the items bundle. If any items are missing, they will be marked as lost</div>
                                [% ELSE %]
                                    <div class="help-block">Optionally scan all barcodes of items found in the items bundle to perform an inventory check. If any items are missing, they will be marked as lost</div>
                                [% END %]
                            </div>

                            <div id="bundle-feedback" class="alert" style="display:none"></div>
                        </div>
                        <div class="modal-footer">
                            <input type="hidden" name="barcode" value="[% item.barcode | html %]" />
                            <input type="hidden" name="op" value="cud-checkin" />
                            <input type="hidden" name="confirm_items_bundle_return" value="1" />
                            [% FOREACH checkin IN checkins %]
                                <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
                                <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
                                <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
                                <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
                                <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
                            [% END %]
                            [% IF item.onloan %]
                                <button type="submit" class="btn btn-default"><i class="fa fa-check"></i> Confirm checkin and mark missing items as lost</button>
                                <button type="submit" class="btn btn-default" name="do_not_verify_items_bundle_contents" value="1"><i class="fa fa-check"></i> Confirm checkin without verifying bundle contents</button>
                            [% ELSE %]
                                <button type="submit" class="btn btn-primary"><i class="fa fa-check"></i> Confirm inventory check and mark items as lost</button>
                            [% END %]
                            <button type="button" data-bs-dismiss="modal" class="btn btn-default"><i class="fa fa-xmark"></i> Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    [% END %]

    [% IF wrongbranch %]
        <div id="wrong-branch-modal" tabindex="-1" class="modal modal-lg block audio-alert-action block" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title"> Cannot check in </h1>
                    </div>
                    <div class="modal-body">
                        <p>
                            <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]"> [% item.barcode | html %]: [% title | html %] </a>
                        </p>
                        <p>
                            <strong> NOT CHECKED IN </strong>
                        </p>
                        <p>
                            This item must be checked in at following library:
                            <strong> [% Branches.GetName( rightbranch ) | html %] </strong>
                        </p>
                        [% INCLUDE all_checkin_messages %]
                    </div>
                    <!-- /.modal-body -->
                    <div class="modal-footer">
                        <button type="button" data-bs-dismiss="modal" class="btn btn-primary"><i class="fa fa-check"></i> OK</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /#wrong-branch-modal -->
    [% END # /IF wrongbranch %]

    <!-- case of a mistake in transfer loop -->
    [% UNLESS ( hold_auto_filled && diffbranch ) %]
        [% IF WrongTransfer && !transfertodo %]
            [% IF Koha.Preference('TransfersBlockCirc') %]
                [% SET div_class='block' %]
            [% ELSE %]
                [% SET div_class='noblock' %]
            [% END %]
            <div id="wrong-transfer-modal" class="modal modal-lg audio-alert-action [% div_class | html %]" [% IF Koha.Preference('TransfersBlockCirc') %]data-bs-backdrop="static" data-bs-keyboard="false"[% END %]>
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="returns.pl" name="wrongtransferform" id="wrongtransferform">
                            [% INCLUDE 'csrf-token.inc' %]
                            <input type="hidden" name="op" value="cud-transfer" />
                            <input type="hidden" name="return_date_override" value="[% return_date_override | html %]" />
                            <input type="hidden" name="return_date_override_remember" value="[% return_date_override_remember | html %]" />
                            <input type="hidden" name="itemnumber" value="[% itemnumber | html %]" />
                            <input type="hidden" name="transit" value="[% NewTransfer | html %]" />
                            <input type="hidden" name="dropboxmode" value="[% dropboxmode | html %]" />
                            <input type="hidden" name="exemptfine" value="[% exemptfine | html %]" />
                            [% FOREACH checkin IN checkins %]
                                <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
                                <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
                                <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
                                <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
                                <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
                            [% END %]

                            <div class="modal-header">
                                <h1 class="modal-title"> Wrong transfer detected, please return item to: [% Branches.GetName( TransferWaitingAt ) | html %] </h1>
                            </div>

                            <div class="modal-body">
                                <p>
                                    <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]">[% item.barcode | html %]: [% title | html %]</a>
                                </p>

                                [% INCLUDE all_checkin_messages %]
                            </div>

                            <div class="modal-footer">
                                <!-- CONFIRM -->
                                <button class="btn btn-default approve" type="submit" accesskey="y"><i class="fa fa-check"></i> OK (Y)</button>
                                <!-- PRINT SLIP -->
                                <button
                                    type="button"
                                    data-bs-dismiss="modal"
                                    class="btn btn-default submit openWin"
                                    data-transfer="[% NewTransfer | html %]"
                                    data-url="transfer-slip.pl?transferitem=[% itemnumber | uri %]&amp;&amp;branchcode=[% TransferWaitingAt | uri %]&amp;op=slip"
                                    accesskey="p"
                                    ><i class="fa fa-print"></i> Print transfer slip (P)</button
                                >
                                <!-- CANCEL TRANSFER -->
                                <button type="button" class="btn btn-default deny cancel" accesskey="x"><i class="fa fa-times"></i> Cancel transfer (X)</button>
                            </div>
                            <!-- /.modal-footer -->
                        </form>
                        <!-- /wrongtransferform -->
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /#wrong-transfer-modal -->
        [% END # /IF WrongTransfer && !transfertodo %]
    [% END # /UNLESS hold_auto_filled && diffbranch %]

    [% IF ( found ) %]
        [% IF ( waiting ) %]
            <div id="hold-found1" class="modal modal-lg block audio-alert-action" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="returns.pl" class="confirm">
                            [% INCLUDE 'csrf-token.inc' %]
                            <div class="modal-header">
                                <h1 class="modal-title">
                                    Hold found (item is already waiting):
                                    <br />
                                    <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]">[% title | html %]</a>
                                    <div class="hold-found-barcode">
                                        <a href="/cgi-bin/koha/catalogue/moredetail.pl?biblionumber=[% itembiblionumber | uri %]&amp;itemnumber=[% itemnumber | uri %]">[% item.barcode | html %]</a>
                                    </div>
                                </h1>
                            </div>

                            <div class="modal-body">
                                [% IF ( reservenotes ) %]
                                    <h4>Notes: [% reservenotes | html %]</h4>
                                [% END %]

                                <h4>Hold for:</h4>
                                <ul>
                                    <li>
                                        [% INCLUDE 'patron-title.inc' patron=patron hide_patron_infos_if_needed=1 invert_name=1 link_to="circulation_reserves" %]
                                        <span class="patron-category"> - [% patron.category.description | html %]</span>
                                    </li>
                                    [% INCLUDE display_holdpatron_address %]
                                    [% IF ( patron.phone ) %]
                                        <li> [% patron.phone | html %]</li>
                                    [% END %]

                                    [% IF ( patron.email ) %]
                                        <li><a id="boremail" href="mailto:[% patron.email | html %]">[% patron.email | html %]</a></li>
                                    [% END %]

                                    [% IF ( patron.is_debarred ) %]
                                        <li class="error">Patron is RESTRICTED</li>
                                    [% END %]

                                    [% IF ( patron.gonenoaddress ) %]
                                        <li class="error">Patron's address is in doubt</li>
                                    [% END %]
                                </ul>

                                [% IF ( transfertodo ) %]
                                    <h4><strong>Transfer to:</strong> [% Branches.GetName( destbranch ) | html %]</h4>
                                [% ELSE %]
                                    <h4><strong>Hold at</strong> [% Branches.GetName( destbranch ) | html %]</h4>
                                [% END %]

                                [% FOREACH checkin IN checkins %]
                                    <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
                                    <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
                                    <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
                                    <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
                                    <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
                                [% END %]

                                <input type="hidden" name="op" value="cud-affect_reserve" />
                                <input type="hidden" name="itemnumber" value="[% itemnumber | html %]" />
                                <input type="hidden" name="borrowernumber" value="[% patron.borrowernumber | html %]" />
                                <input type="hidden" name="biblionumber" value="[% itembiblionumber | html %]" />
                                <input type="hidden" name="reserve_id" value="[% reserve_id | html %]" />
                                <input type="hidden" name="diffBranch" value="[% destbranch | html %]" />
                                <input type="hidden" name="exemptfine" value="[% exemptfine | html %]" />
                                <input type="hidden" name="dropboxmode" value="[% dropboxmode | html %]" />
                                <input type="hidden" name="forgivemanualholdsexpire" value="[% forgivemanualholdsexpire | html %]" />

                                <input type="hidden" name="return_date_override" value="[% return_date_override | html %]" />
                                <input type="hidden" name="return_date_override_remember" value="[% return_date_override_remember | html %]" />
                                [% INCLUDE all_checkin_messages %]
                            </div>
                            <!-- /.modal-body -->

                            <div class="modal-footer">
                                <input type="hidden" name="cancel_reserve" value="0" />
                                <input type="hidden" name="cancel_reason" value="" />
                                <input id="confirm-hold-barcode" type="hidden" name="barcode" value="[% barcode | html %]" />

                                <button type="submit" class="btn btn-default approve" data-bs-dismiss="modal" accesskey="y"> <i class="fa fa-check"></i> Confirm hold (Y) </button>

                                <input type="hidden" name="print_slip" value="0" />
                                <button type="button" class="btn btn-default print" accesskey="P"> <i class="fa fa-print"></i> Print slip and confirm (P) </button>
                                <form method="post" action="returns.pl" class="confirm">
                                    <input type="hidden" name="op" value="cud-ignore_reserve" />
                                    <input type="hidden" name="ignoreitem" value="[% itemnumber | html %]" />
                                    [% INCLUDE 'csrf-token.inc' %]
                                    [% FOREACH inputloo IN inputloop %]
                                        <input type="hidden" name="ri-[% inputloo.counter | html %]" value="[% inputloo.barcode | html %]" />
                                        <input type="hidden" name="dd-[% inputloo.counter | html %]" value="[% inputloo.duedate | html %]" />
                                        <input type="hidden" name="bn-[% inputloo.counter | html %]" value="[% inputloo.borrowernumber | html %]" />
                                        <input type="hidden" name="nr-[% inputloo.counter | html %]" value="[% inputloo.not_returned | html %]" />
                                    [% END %]
                                    <button type="submit" data-bs-dismiss="modal" class="btn btn-default deny" accesskey="i"> <i class="fa fa-times"></i> Ignore (I) </button>
                                </form>

                                <fieldset class="action">
                                    [% SET hold_cancellation = AuthorisedValues.GetAuthValueDropbox('HOLD_CANCELLATION') %]
                                    [% IF hold_cancellation.count %]
                                        <select name="cancellation-reason" id="cancellation-reason">
                                            <option value="">No reason given</option>
                                            [% FOREACH reason IN hold_cancellation %]
                                                <option value="[% reason.authorised_value | html %]">[% reason.lib | html %]</option>
                                            [% END %]
                                        </select>
                                    [% END %]
                                    <button type="button" class="btn btn-default deny cancel-hold" accesskey="X"> <i class="fa fa-trash-can"></i> Cancel hold (X) </button>
                                </fieldset>
                            </div>
                            <!-- /.modal-footer -->
                        </form>
                        <!-- /.confirm -->
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /#hold-found1 -->
        [% END # /IF waiting %]

        [% IF (transfer || needstransfer) && !(reserved and !recalled and !waitingrecall) %]
            [% IF Koha.Preference('TransfersBlockCirc') %]
                [% SET div_class='block' %]
            [% ELSE %]
                [% SET div_class='noblock' %]
            [% END %]
            <div id="item-transfer-modal" class="modal modal-lg [% div_class | html %] audio-alert-action" [% IF Koha.Preference('TransfersBlockCirc') %]data-bs-backdrop="static" data-bs-keyboard="false"[% END %]>
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="returns.pl" name="mainform" id="mainform">
                            [% INCLUDE 'csrf-token.inc' %]

                            <input type="hidden" name="print_slip" value="0" />

                            <div class="modal-header">
                                <h1 class="modal-title"> Please return this item to [% IF transferto %][% Branches.GetName( transferto ) | html %][% ELSE %][% Branches.GetName( returnbranch ) | html %][% END %] </h1>
                            </div>
                            <div class="modal-body">
                                <p>
                                    <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]"> [% item.barcode | html %]: [% title | html %] </a>
                                </p>
                                [% IF !transfer %]
                                    <p> Transfer now? </p>
                                [% END %]
                                <input type="hidden" name="tobranch" value="[% returnbranch | html %]" />
                                <input type="hidden" name="transferitem" value="[% itemnumber | html %]" />
                                <input type="hidden" name="barcode" value="0" />
                                <input type="hidden" name="trigger" value="[% trigger | html %]" />
                                [% INCLUDE all_checkin_messages %]
                            </div>
                            <div class="modal-footer">
                                [% IF !transfer %]
                                    <input type="hidden" name="op" value="cud-dotransfer" />
                                    <button type="submit" name="dotransfer" value="Yes" class="btn btn-default approve" accesskey="y"><i class="fa fa-check"></i> Yes (Y)</button>
                                    <button type="button" name="dotransfer" class="btn btn-default print openWin" data-url="transfer-slip.pl?transferitem=[% itemnumber | uri %]&amp;&amp;branchcode=[% returnbranch | uri %]&amp;op=slip"
                                        ><i class="fa fa-print"></i> Yes, print slip</button
                                    >
                                    <button type="button" data-bs-dismiss="modal" class="btn btn-default deny" name="notransfer" value="No" accesskey="n"><i class="fa fa-times"></i> No (N)</button>
                                [% ELSE %]
                                    <input type="hidden" name="op" value="cud-transfer" />
                                    <input type="hidden" name="transit" value="[% transfer | uri %]" />
                                    <button type="submit" data-bs-dismiss="modal" class="btn btn-default" accesskey="y"><i class="fa fa-check"></i> OK (Y)</button>
                                    <button
                                        type="button"
                                        data-bs-dismiss="modal"
                                        class="btn btn-default print openWin"
                                        data-url="transfer-slip.pl?transferitem=[% itemnumber | uri %]&amp;branchcode=[% returnbranch | uri %]&amp;op=slip"
                                        accesskey="p"
                                        ><i class="fa fa-print"></i> Print slip (P)</button
                                    >
                                [% END %]
                                <input type="hidden" name="return_date_override" value="[% return_date_override | html %]" />
                                <input type="hidden" name="return_date_override_remember" value="[% return_date_override_remember | html %]" />
                                <input type="hidden" name="exemptfine" value="[% exemptfine | html %]" />
                                <input type="hidden" name="dropboxmode" value="[% dropboxmode | html %]" />
                                <input type="hidden" name="forgivemanualholdsexpire" value="[% forgivemanualholdsexpire | html %]" />

                                [% FOREACH checkin IN checkins %]
                                    <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
                                    <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
                                    <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
                                    <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
                                    <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
                                [% END %]
                            </div>
                            <!-- /.modal-footer -->
                        </form>
                        <!-- /#mainform -->
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /#item-transfer-modal -->
        [% END # /IF transfer || needstransfer %]

        <!-- case of simple return no issue or transfer but with a hold  -->
        [% IF ( reserved and !recalled and !waitingrecall ) %]

            [% SET confirm_button_text = '' %]
            [% SET print_button = '' %]

            [% IF transfertodo %]
                [% confirm_button_text = t('Confirm hold and transfer') %]
                [% print_button = '<button type="button" class="btn btn-default print" accesskey="p"> <i class="fa fa-print"></i> ' _ t('Print slip, transfer, and confirm') _ ' (P) </button>' %]
            [% ELSE %]
                [% confirm_button_text = t('Confirm hold') %]
                [% print_button = '<button type="button" class="btn btn-default print" accesskey="p"> <i class="fa fa-print"></i> ' _ t('Print slip and confirm') _ ' (P) </button>' %]
            [% END %]

            [% SET modal_print_url = reserve_id | uri %]
            [% modal_print_url = "/cgi-bin/koha/circ/hold-transfer-slip.pl?reserve_id=" _ modal_print_url %]

            [% WRAPPER modal_wrapper modal_id="hold-found-modal" modal_header_text=t('Hold found') modal_confirm_text=confirm_button_text modal_confirm_accesskey="Y" modal_custom_utility_button=print_button modal_deny_text= t('Ignore') modal_deny_accesskey="I" modal_deny_action="dismiss" %]
                <h1>
                    <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% itembiblionumber | uri %]">[% title | html %]</a>
                    <div class="hold-found-barcode"> (<a href="/cgi-bin/koha/catalogue/moredetail.pl?biblionumber=[% itembiblionumber | uri %]&amp;itemnumber=[% itemnumber | uri %]">[% item.barcode | html %]</a>) </div>
                </h1>
                [% IF ( reservenotes ) %]
                    <h4>[% t('Notes') | html %]:</h4>
                    <p>[% reservenotes | html %]</p>
                    <hr />
                [% END %]
                <h4>[% t('Hold for') | html %]:</h4>
                <ul>
                    <li>
                        [% INCLUDE 'patron-title.inc' patron=patron hide_patron_infos_if_needed=1 invert_name=1 link_to="circulation_reserves" %]
                        <span class="patron-category"> - [% patron.category.description | html %]</span>
                    </li>

                    [% INCLUDE display_holdpatron_address %]

                    [% IF ( patron.phone ) %]
                        <li>[% patron.phone | html %]</li>
                    [% END %]

                    [% IF ( patron.email ) %]
                        <li>
                            [% IF ( transfertodo ) %]
                                [% patron.email | html %]
                            [% ELSE %]
                                <a id="boremail" href="mailto:[% patron.email | html %]">[% patron.email | html %]</a>
                            [% END %]
                        </li>
                    [% END %]

                    [% UNLESS ( transfertodo) %]
                        [% INCLUDE display_bormessagepref %]
                        [% IF patron.primary_contact_method %]
                            <li id="main_contact_method">
                                [% t('Main contact method') | html %]:
                                [% SWITCH patron.primary_contact_method %]
                                [% CASE 'phone' %]
                                    <span>[% t('Primary phone') | html %]</span>
                                [% CASE 'phonepro' %]
                                    <span>[% t('Secondary phone') | html %]</span>
                                [% CASE 'mobile' %]
                                    <span>[% t('Other phone') | html %]</span>
                                [% CASE 'email' %]
                                    <span>[% t('Primary email') | html %]</span>
                                [% CASE 'emailpro' %]
                                    <span>[% t('Secondary email') | html %]</span>
                                [% CASE 'fax' %]
                                    <span>[% t('Fax') | html %]</span>
                                [% END %]
                            </li>
                        [% END %]
                    [% END %]

                    [% IF ( patron.is_debarred ) %]
                        <li class="error">[% t('Patron is RESTRICTED') | html %]</li>
                    [% END %]

                    [% IF ( patron.gonenoaddress ) %]
                        <li class="error">[% t("Patron's address is in doubt") | html %]</li>
                    [% END %]
                </ul>
                [% IF ( transfertodo ) %]
                    <h4><strong>[% t('Transfer to') | html %]:</strong> [% Branches.GetName( destbranch ) | html %]</h4>
                [% ELSE %]
                    <h4><strong>[% t('Hold at') | html %]</strong> [% Branches.GetName( destbranch ) | html %]</h4>
                [% END %]

                [% PROCESS passthrough_data %]

                <input type="hidden" name="op" value="cud-affect_reserve" />
                <input type="hidden" name="itemnumber" value="[% itemnumber | html %]" />
                <input type="hidden" name="borrowernumber" value="[% patron.borrowernumber | html %]" />
                <input type="hidden" name="biblionumber" value="[% itembiblionumber | html %]" />
                <input type="hidden" name="reserve_id" value="[% reserve_id | html %]" />
                <input type="hidden" name="diffBranch" value="[% destbranch | html %]" />
                <input type="hidden" name="forgivemanualholdsexpire" value="[% forgivemanualholdsexpire | html %]" />
                <input type="hidden" name="print_slip" value="0" />
                [% INCLUDE all_checkin_messages %]
            [% END #/hold-found-modal %]
        [% END #/IF reserved %]

        [% IF ( recalled ) %]
            <!-- recalled -->
            <div id="recalled" class="modal modal-lg block audio-alert-action" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="/cgi-bin/koha/circ/returns.pl" class="confirm">
                            [% INCLUDE 'csrf-token.inc' %]

                            <div class="modal-header">
                                <h1 class="modal-title">
                                    Recall found:
                                    <br />
                                    <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% recall.biblio_id | uri %]">[% recall.biblio.title | html %]</a>
                                    [% IF recall.item %]
                                        <div class="recall-found-barcode">
                                            (<a href="/cgi-bin/koha/catalogue/moredetail.pl?biblionumber=[% recall.biblio_id | uri %]&amp;itemnumber=[% recall.item_id | uri %]">[% recall.item.barcode | html %]</a>)
                                        </div>
                                    [% END %]
                                </h1>
                            </div>

                            <div class="modal-body">
                                [% IF ( recall.notes ) %]
                                    <h4>Notes:</h4>
                                    <p>[% recall.notes | html %]</p>
                                    <hr />
                                [% END %]
                                <h5>Recall placed by:</h5>
                                <ul>
                                    <li>
                                        [% INCLUDE 'patron-title.inc' patron=recall.patron hide_patron_infos_if_needed=1 invert_name=1 link_to="circulation_recalls" %]
                                        <span class="patron-category"> - [% recall.patron.category.description | html %]</span>
                                    </li>

                                    [% INCLUDE display_holdpatron_address patron=recall.patron %]

                                    [% IF ( recall.patron.phone ) %]
                                        <li>[% recall.patron.phone | html %]</li>
                                    [% END %]

                                    [% IF ( recall.patron.email ) %]
                                        <li>
                                            [% IF ( transfertodo ) %]
                                                [% recall.patron.email | html %]
                                            [% ELSE %]
                                                <a id="boremail" href="mailto:[% recall.patron.email | html %]">[% recall.patron.email | html %]</a>
                                            [% END %]
                                        </li>
                                    [% END %]

                                    [% UNLESS ( transfertodo) %]
                                        [% INCLUDE display_bormessagepref %]
                                    [% END %]

                                    [% IF ( recall.patron.is_debarred ) %]
                                        <li class="error">Patron is RESTRICTED</li>
                                    [% END %]

                                    [% IF ( recall.patron.gonenoaddress ) %]
                                        <li class="error">Patron's address is in doubt</li>
                                    [% END %]
                                </ul>
                                [% IF ( transfertodo ) %]
                                    <h4><strong>Transfer to:</strong> [% Branches.GetName( recall.pickup_library_id ) | html %]</h4>
                                [% ELSE %]
                                    <h4><strong>Recall at</strong> [% Branches.GetName( recall.pickup_library_id ) | html %]</h4>
                                [% END %]

                                <input type="hidden" name="op" value="cud-affect_recall" />
                                <input type="hidden" name="recall_id" value="[% recall.id | html %]" />
                                <input type="hidden" name="itemnumber" value="[% itemnumber | html %]" />
                                <input type="hidden" name="returnbranch" value="[% Branches.GetLoggedInBranchcode | html %]" />
                                <input type="hidden" name="recall_slip" value="0" />
                            </div>

                            <div class="modal-footer">
                                [% IF ( transfertodo ) %]
                                    <button type="submit" class="btn btn-default approve" accesskey="Y"> <i class="fa fa-check"></i> Confirm recall and transfer (Y) </button>
                                    <button type="button" class="btn btn-default print-recall" accesskey="P"> <i class="fa fa-print"></i> Print slip, transfer, and confirm (P) </button>
                                [% ELSE %]
                                    <button type="submit" class="btn btn-default approve" accesskey="Y"> <i class="fa fa-check"></i> Confirm recall (Y) </button>
                                    <button type="button" class="btn btn-default print-recall" accesskey="P"> <i class="fa fa-print"></i> Print slip and confirm (P) </button>
                                [% END %]

                                <button data-bs-dismiss="modal" type="button" class="btn btn-default"> <i class="fa fa-times"></i> Ignore </button>
                            </div>
                            <!-- /.modal-footer -->
                        </form>
                        <!-- /.confirm -->
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /#recalled -->
        [% END #/IF recalled %]

        [% IF ( waitingrecall ) %]
            <!-- recalled -->
            <div id="recalledwaiting" class="modal modal-lg block audio-alert-action" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="/cgi-bin/koha/circ/returns.pl" class="confirm">
                            [% INCLUDE 'csrf-token.inc' %]

                            <div class="modal-header">
                                <h1>
                                    Recall found (item is already waiting):
                                    <br />
                                    <a href="/cgi-bin/koha/catalogue/detail.pl?type=intra&amp;biblionumber=[% recall.biblio_id | uri %]">[% recall.biblio.title | html %]</a>
                                    [% IF recall.item %]
                                        <div class="recall-found-barcode">
                                            (<a href="/cgi-bin/koha/catalogue/moredetail.pl?biblionumber=[% recall.biblio_id | uri %]&amp;itemnumber=[% recall.item_id | uri %]">[% recall.item.barcode | html %]</a>)
                                        </div>
                                    [% END %]
                                </h1>
                            </div>

                            <div class="modal-body">
                                [% IF ( recall.notes ) %]
                                    <h4>Notes:</h4>
                                    <p>[% recall.notes | html %]</p>
                                    <hr />
                                [% END %]
                                <h5>Recall placed by:</h5>
                                <ul>
                                    <li>
                                        [% INCLUDE 'patron-title.inc' patron=recall.patron hide_patron_infos_if_needed=1 invert_name=1 link_to="circulation_recalls" %]
                                        <span class="patron-category"> - [% recall.patron.category.description | html %]</span>
                                    </li>

                                    [% INCLUDE display_holdpatron_address patron=recall.patron %]

                                    [% IF ( recall.patron.phone ) %]
                                        <li>[% recall.patron.phone | html %]</li>
                                    [% END %]

                                    [% IF ( recall.patron.email ) %]
                                        <li>
                                            [% IF ( transfertodo ) %]
                                                [% recall.patron.email | html %]
                                            [% ELSE %]
                                                <a id="boremail" href="mailto:[% recall.patron.email | html %]">[% recall.patron.email | html %]</a>
                                            [% END %]
                                        </li>
                                    [% END %]

                                    [% UNLESS ( transfertodo) %]
                                        [% INCLUDE display_bormessagepref %]
                                    [% END %]

                                    [% IF ( recall.patron.is_debarred ) %]
                                        <li class="error">Patron is RESTRICTED</li>
                                    [% END %]

                                    [% IF ( recall.patron.gonenoaddress ) %]
                                        <li class="error">Patron's address is in doubt</li>
                                    [% END %]
                                </ul>
                                [% IF ( transfertodo ) %]
                                    <h4><strong>Transfer to:</strong> [% Branches.GetName( recall.pickup_library_id ) | html %]</h4>
                                [% ELSE %]
                                    <h4><strong>Wait for pickup at</strong> [% Branches.GetName( recall.pickup_library_id ) | html %]</h4>
                                [% END %]

                                <input type="hidden" name="op" value="cud-affect_recall" />
                                <input type="hidden" name="recall_id" value="[% recall.id | html %]" />
                                <input type="hidden" name="itemnumber" value="[% itemnumber | html %]" />
                                <input type="hidden" name="returnbranch" value="[% Branches.GetLoggedInBranchcode | html %]" />
                                <input type="hidden" name="recall_slip" value="0" />
                            </div>

                            <div class="modal-footer">
                                <button type="submit" class="btn btn-default approve" accesskey="Y"> <i class="fa fa-check"></i> Confirm recall (Y) </button>
                                <button type="button" class="btn btn-default print-recall" accesskey="P"> <i class="fa fa-print"></i> Print slip and confirm (P) </button>

                                <button data-bs-dismiss="modal" type="button" class="btn btn-default deny" accesskey="I"> <i class="fa fa-times"></i> Ignore (I) </button>
                            </div>
                            <!-- /.modal-footer -->
                        </form>
                        <!-- /.confirm -->
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /#recalledwaiting-->
        [% END #/IF recalledwaiting %]
    [% END # /IF found %]

    <div class="static_checkin_messages"> [% INCLUDE all_checkin_messages %] </div>

    <form id="checkin-form" method="post" action="/cgi-bin/koha/circ/returns.pl" autocomplete="off">
        [% INCLUDE 'csrf-token.inc' %]
        <fieldset id="circ_returns_checkin">
            <div class="show_checkin_dialog" style="float:right;display:none"
                ><button type="button" class="btn btn-default btn-sm" data-bs-toggle="tooltip" title="Show the last checkin message"><i class="fa fa-info"></i></button
            ></div>
            <h1>Check in</h1>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-control-group">
                        [% IF ( exemptfine || dropboxmode ) %]
                            <input name="barcode" id="barcode" size="14" placeholder="Enter item barcode" class="barcode focus input-warning" type="text" />
                        [% ELSE %]
                            <input name="barcode" id="barcode" size="14" placeholder="Enter item barcode" class="barcode focus" type="text" />
                        [% END %]
                        <input type="hidden" name="op" value="cud-checkin" />

                        <div id="show-circ-settings">
                            <a href="#" title="Checkin settings"><i class="fa-solid fa-sliders"></i></a>
                        </div>

                        [% FOREACH checkin IN checkins %]
                            <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
                            <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
                            <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
                            <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
                            <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
                        [% END %]

                        <button type="submit" class="btn btn-primary">Check in</button>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div id="exemptfines" class="checkin-active-setting" [% UNLESS exemptfine %]style="display:none;"[% END %]>
                        <p><i class="fa fa-check"></i> Fines for returned items are forgiven.</p>
                    </div>

                    <div id="forgivemanualholdsexpire-alert" class="checkin-active-setting" [% UNLESS forgivemanualholdsexpire %]style="display:none;"[% END %]>
                        <p><i class="fa fa-check"></i> Fines are not charged for manually cancelled holds.</p>
                    </div>

                    <div id="dropboxmode" class="checkin-active-setting" [% UNLESS dropboxmode %]style="display:none;"[% END %]>
                        <p><i class="fa fa-check"></i> Book drop mode. <span class="single-line">( Effective checkin date is [% dropboxdate | $KohaDates with_hours => 1 %] )</span></p>
                    </div>

                    <div id="return_date_remember" class="checkin-active-setting" [% UNLESS return_date_override_remember %]style="display:none;"[% END %]>
                        <p><i class="fa fa-check"></i> Saved check-in date: <span id="saved_return_date" class="single-line">[% return_date_override | html %]</span></p>
                    </div>
                </div>
            </div>

            <div class="circ-settings">
                [% IF Koha.Preference('SpecifyReturnDate') %]
                    <div class="date-select" id="return_date_override_fields">
                        <div class="hint">Specify return date [% INCLUDE 'date-format.inc' %]: </div>

                        <input
                            type="text"
                            size="20"
                            id="return_date_override"
                            name="return_date_override"
                            value="[% return_date_override | html %]"
                            class="flatpickr"
                            data-flatpickr-pastinclusive="true"
                            data-flatpickr-enable-time="true"
                            data-flatpickr-on-close-focus="#barcode"
                        />

                        <div class="circ-setting">
                            [% IF ( return_date_override_remember ) %]
                                <input type="checkbox" id="return_date_override_remember" name="return_date_override_remember" checked="checked" />
                            [% ELSE %]
                                <input type="checkbox" id="return_date_override_remember" name="return_date_override_remember" />
                            [% END %]
                            <label for="return_date_override_remember"> Remember return date for next check in</label>
                        </div>
                    </div>
                    <!-- /.date-select -->
                [% END %]

                [% IF ( CAN_user_updatecharges_writeoff && overduecharges ) %]
                    <div id="forgive-overdue-fines" class="circ-setting">
                        [% IF ( exemptfine ) %]
                            <input type="checkbox" id="exemptcheck" name="exemptfine" value="exemptfine" checked="checked" />
                        [% ELSE %]
                            <input type="checkbox" id="exemptcheck" name="exemptfine" value="exemptfine" />
                        [% END %]
                        <label for="exemptcheck">Forgive overdue charges</label>
                    </div>
                [% END %]
                <!-- overduecharges -->

                <div id="book-drop-mode" class="circ-setting">
                    [% IF ( dropboxmode ) %]
                        <input type="checkbox" id="dropboxcheck" name="dropboxmode" value="dropboxmode" checked="checked" />
                    [% ELSE %]
                        <input type="checkbox" id="dropboxcheck" name="dropboxmode" value="dropboxmode" />
                    [% END %]
                    <label for="dropboxcheck">Book drop mode</label>
                </div>

                [% IF Koha.Preference('ExpireReservesMaxPickUpDelayCharge') %]
                    <div class="forgive-manual-hold-fees circ-setting">
                        [% IF ( forgivemanualholdsexpire ) %]
                            <input type="checkbox" id="forgivemanualholdsexpire" name="forgivemanualholdsexpire" value="forgivemanualholdsexpire" checked="checked" />
                        [% ELSE %]
                            <input type="checkbox" id="forgivemanualholdsexpire" name="forgivemanualholdsexpire" value="forgivemanualholdsexpire" />
                        [% END %]
                        <label for="forgivemanualholdsexpire">Forgive fees for manually expired holds</label>
                    </div>
                [% END %]
                <!-- overduecharges -->
            </div>
            <!-- /.circ-settings -->
        </fieldset>
        <!-- /#circ_returns_checkin -->
    </form>
    <!-- /#checkin-form -->

    [% IF ( checkins.size ) %]
        <div class="page-section">
            <h2>Checked-in items</h2>
            <table id="checkedintable">
                <thead>
                    <tr>
                        <th class="ci-duedate">Due date</th>
                        <th class="ci-title">Title</th>
                        <th class="ci-author">Author</th>
                        <th class="ci-barcode">Barcode</th>
                        <th class="ci-homelibrary">Home library</th>
                        <th class="ci-transferlibrary">Transfer to</th>
                        <th class="ci-transferreason">Transfer reason</th>
                        <th class="ci-shelvinglocation">Shelving location</th>
                        <th class="ci-callnumber">Call number</th>
                        <th class="ci-dateaccessioned">Date acquired</th>
                        <th class="ci-recordlevelitemtype">Record-level itemtype</th>
                        <th class="ci-itemtype">Item type</th>
                        <th class="ci-collection">Collection</th>
                        <th class="ci-patron">Patron</th>
                        <th class="ci-note">Note</th>
                    </tr>
                </thead>

                [% FOREACH checkin IN checkins %]
                    <tr>
                        <td class="ci-duedate">
                            [% IF ( checkin.not_returned AND checkin.duedate ) %]
                                <span class="problem not_returned">Item was not checked in</span>
                            [% END %]
                            [% IF ( checkin.duedate ) %]
                                [% IF ( checkin.return_overdue ) %]
                                    <span class="overdue">[% checkin.duedate | $KohaDates as_due_date => 1 %] (overdue)</span>
                                [% ELSE %]
                                    [% checkin.duedate | $KohaDates as_due_date => 1 %]
                                [% END %]
                            [% ELSE %]
                                <span>Not checked out</span>
                            [% END %]
                            [% IF ( checkin.item.damaged ) %]
                                <span class="dmg">[% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.damaged', authorised_value => checkin.item.damaged ) | html %]</span>
                            [% END %]
                            [% IF ( checkin.item.withdrawn ) %]
                                <span class="withdrawn">[% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.withdrawn', authorised_value => checkin.item.withdrawn ) | html %]</span>
                            [% END %]
                        </td>
                        <td class="ci-title">
                            <a href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% checkin.biblio.biblionumber | uri %]">
                                [% checkin.biblio.title | html %]
                                <!-- prettier-ignore-start -->
                                [% FOREACH subtitle IN checkin.biblio.subtitle.split(' \\| ') %] <span class="subtitle">[% subtitle | html %]</span>[% END %]
                                [% FOREACH part_number IN checkin.biblio.part_number.split(' \\| ') %] <span class="part_number">[% part_number | html %]</span>[% END %]
                                [% FOREACH part_name IN checkin.biblio.part_name.split(' \\| ') %] <span class="part_name">[% part_name | html %]<span>[% END %]
                                <!-- prettier-ignore-end -->
                            </a>
                            [% IF ( checkin.item.enumchron ) %]
                                <br />
                                <span class="item_enumeration" style="white-space: nowrap;">[% checkin.item.enumchron | html %]</span>
                            [% END %]
                        </td>
                        <td class="ci-author">[% checkin.biblio.author | html %]</td>
                        <td class="ci-barcode">
                            <a href="/cgi-bin/koha/catalogue/moredetail.pl?biblionumber=[% checkin.biblio.biblionumber | uri %]&amp;itemnumber=[% checkin.item.itemnumber | uri %]#item[% checkin.item.itemnumber | uri %]"
                                >[% checkin.barcode | html %]</a
                            >
                        </td>
                        <td class="ci-homelibrary"> [% Branches.GetName( checkin.item.homebranch ) | html %] </td>
                        [% SET transfer = checkin.item.get_transfer %]
                        <td class="ci-transferlibrary"> [% IF transfer %][% Branches.GetName( transfer.tobranch ) | html %][% END %]</td>
                        <td class="ci-transferreason">
                            [% IF transfer %]
                                [%- SWITCH transfer.reason -%]

                                [%- CASE 'Manual' -%]
                                    <span>Manual</span>
                                [%- CASE 'StockrotationAdvance' -%]
                                    <span>Stock rotation advance</span>
                                [%- CASE 'StockrotationRepatriation' -%]
                                    <span>Stock rotation repatriation</span>
                                [%- CASE 'ReturnToHome' -%]
                                    <span>Return to home library</span>
                                [%- CASE 'ReturnToHolding' -%]
                                    <span>Return to holding library</span>
                                [%- CASE 'RotatingCollection' -%]
                                    <span>Rotating collection</span>
                                [%- CASE 'Reserve' -%]
                                    <span>Hold</span>
                                [%- CASE 'LostReserve' -%]
                                    <span>Lost hold</span>
                                [%- CASE 'CancelReserve' -%]
                                    <span>Cancelled hold</span>
                                [%- CASE 'TransferCancellation' -%]
                                    <span>Transfer was cancelled whilst in transit</span>
                                [%- CASE 'Recall' -%]
                                    <span>Recall</span>
                                [%- CASE 'RecallCancellation' -%]
                                    <span>Cancelled recall</span>
                                [%- END -%]
                            [%- END -%]
                        </td>
                        <td class="ci-shelvinglocation">
                            <span class="shelvingloc">[% checkin.item_location | html %]</span>
                        </td>
                        <td class="ci-callnumber"> [% checkin.item.itemcallnumber | html %] </td>
                        <td class="ci-dateaccessioned"> [% checkin.item.dateaccessioned | $KohaDates %] </td>
                        <td class="ci-recordlevelitemtype"> [% ItemTypes.GetDescription( checkin.biblio.itemtype ) | html %] </td>
                        <td class="ci-itemtype"> [% ItemTypes.GetDescription( checkin.item.itype ) | html %] </td>
                        <td class="ci-collection"> [% AuthorisedValues.GetDescriptionByKohaField( kohafield => 'items.ccode', authorised_value => checkin.item.ccode) | html %] </td>
                        <td class="ci-patron">
                            [% IF ( checkin.duedate ) %]
                                [% INCLUDE 'patron-title.inc' patron=checkin.patron hide_patron_infos_if_needed=1 invert_name=1 %]
                                [% SET issues_count = checkin.patron.checkouts.count %]
                                [% IF issues_count %]
                                    <span class="results_summary nowrap">
                                        <span class="label">Checkouts:</span>
                                        <span class="badge bg-info-subtle">
                                            <a href="/cgi-bin/koha/circ/circulation.pl?borrowernumber=[% checkin.patron.borrowernumber | uri %]">[% issues_count | html %]</a>
                                        </span>
                                    </span>
                                [% END %]
                                [% IF checkin.patron.privacy < 2 %]
                                    [%# 2 is the privacy rule "Never" (Delete my history immediately) %]
                                    <a class="btn btn-default btn-xs printcheckinslip" href="#" data-borrowernumber="[% checkin.patron.borrowernumber | html %]"><i class="fa fa-print"></i> Print checkin slip</a>
                                [% END %]
                            [% ELSE %]
                                Not checked out
                            [% END %]
                        </td>
                        <td class="ci-note">
                            [% IF ( checkin.patron.borrowernotes ) %]
                                <p><span class="circ-hlt patron-note">[% checkin.patron.borrowernotes | $raw | html_line_break %]</span></p>
                            [% END %]
                            [% IF ( checkin.item.itemnotes ) %]
                                <p><span class="circ-hlt item-note-public">[% checkin.item.itemnotes | html %]</span></p>
                            [% END %]
                            [% IF ( checkin.item.itemnotes_nonpublic ) %]
                                <p><span class="circ-hlt item-note-nonpublic">[% checkin.item.itemnotes_nonpublic | html %]</span></p>
                            [% END %]
                        </td>
                    </tr>
                [% END # /FOREACH checkins %]
            </table>
            <!-- /#checkedintable --> </div
        ><!-- /.page-section -->
    [% END # /IF checkins.count %]
[% END %]

[% IF ( ReturnClaims ) %]
    [% INCLUDE 'modals/resolve_return_claim.inc' %]
[% END %]

[% INCLUDE 'modals/bundle_contents.inc' %]

[% IF ( missing_items ) %]
    <!-- Bundle missing modal -->
    <div class="modal modal-lg noblock printable" id="bundleMissingModal" tabindex="-1" role="dialog" aria-labelledby="bundleMissingLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title" id="bundleMissingLabel">Items missing from bundle at checkin for [% item.barcode | html %]</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table style="width:100%">
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Title</th>
                            </tr>
                        </thead>
                        <tbody>
                            [% FOREACH bundle_item IN missing_items %]
                                <tr>
                                    <td>[% bundle_item.barcode | html %]</td>
                                    <td>[% INCLUDE 'biblio-title.inc' biblio=bundle_item.biblio %]</td>
                                </tr>
                            [% END %]
                        </tbody>
                        <tfoot> </tfoot>
                    </table>
                </div>
                <!-- /.modal-body -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="printModal btn btn-primary"><i class="fa fa-print"></i> Print</button>
                </div>
                <!-- /.modal-footer -->
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /#bundleMissingModal -->
[% END %]

[% IF ( Koha.Preference('CatalogConcerns') ) %]
    [% INCLUDE 'modals/add_catalog_concern.inc' %]
[% END %]

[%# passthrough_data: adds hidden inputs for any data that needs to be preserved and passed back to the controller after a modal response %]
[% BLOCK passthrough_data %]
    <fieldset id="checkin_passthrough">
        <input type="hidden" name="return_date_override" value="[% return_date_override | html %]" />
        <input type="hidden" name="return_date_override_remember" value="[% return_date_override_remember | html %]" />
        <input type="hidden" name="dropboxmode" value="[% dropboxmode | html %]" />
        <input type="hidden" name="exemptfine" value="[% exemptfine | html %]" />
        [% FOREACH checkin IN checkins %]
            <input type="hidden" name="checkin_counter" value="[% loop.count | html %]" />
            <input type="hidden" name="checkin_barcode_[% loop.count | html %]" value="[% checkin.barcode | html %]" />
            <input type="hidden" name="checkin_duedate_[% loop.count | html %]" value="[% checkin.duedate | html %]" />
            <input type="hidden" name="checkin_borrowernumber_[% loop.count | html %]" value="[% checkin.borrowernumber | html %]" />
            <input type="hidden" name="checkin_not_returned_[% loop.count | html %]" value="[% checkin.not_returned | html %]" />
        [% END %]
    </fieldset>
[% END %]

[% MACRO jsinclude BLOCK %]
    [% INCLUDE 'datatables.inc' %]
    [% INCLUDE 'calendar.inc' %]
    [% Asset.js("js/pages/circulation.js") | $raw %]
    [% Asset.js("js/modal_printer.js") | $raw %]
    [% IF ( ReturnClaims ) %]
        <script>
            /* Set a variable needed by resolve_claim_modal.js */
            var logged_in_user_borrowernumber = "[% logged_in_user.borrowernumber | html %]";
        </script>
        [% Asset.js("js/resolve_claim_modal.js") | $raw %]
    [% END %]
    [% IF ( Koha.Preference('CatalogConcerns') ) %]
        <script>
            /* Set a variable needed by add_catalog_concern.js */
            var logged_in_user_borrowernumber = "[% logged_in_user.borrowernumber | html %]";
        </script>
        [% Asset.js("js/modals/add_catalog_concern.js") | $raw %]
    [% END %]
    <script>
        function Dopop(link) {
            var newin = window.open(link, 'popup', 'width=600,height=400,resizable=1,toolbar=0,scrollbars=1,top');
            $("#barcode").focus();
        }
        $(document).ready(function () {
            $("#checkin-form").preventDoubleFormSubmit();

            $(".modal.block")
            .on('shown.bs.modal', function() {
                $("#barcode").prop("disabled", true);
                $(".show_checkin_dialog").show();
            }).on('hidden.bs.modal', function() {
                $("#barcode").prop("disabled", false).focus();
            })
            .modal("show");

            $(".modal.noblock").modal('show')
            .on('shown.bs.modal', function() {
                $("#barcode").prop("disabled", false).focus();
            }).on('hidden.bs.modal', function() {
                $("#barcode").prop("disabled", false).focus();
            });

            $("body").on("click", ".show_checkin_dialog button", function(e){
                e.preventDefault();
                $(".modal.audio-alert-action").modal("show");
            });
            [% IF reserve_id %]
                $(".print-slip").on('click', function(e) {
                    e.preventDefault();
                    Dopop("hold-transfer-slip.pl?reserve_id=[% reserve_id | uri %]");
                });
                [% IF print_slip %]
                    Dopop("hold-transfer-slip.pl?reserve_id=[% reserve_id | uri %]");
                [% END %]
            [% END %]
            var table_settings = [% TablesSettings.GetTableSettings( 'circ', 'returns', 'checkedintable', 'json' ) | $raw %]

            [% IF recall_slip %]
                Dopop('/cgi-bin/koha/recalls/recall_pickup_slip.pl?recall_id=[% recall_id | uri %]');
            [% END %]

            var returns_table = $("#checkedintable").kohaTable(
                {
                    searching: false,
                    paging: false,
                    info: false,
                    ordering: false,
                    dom: '<"table_controls"B>rt',
                },
                table_settings
            );

            $("#exemptcheck").change(function () {
                if (this.checked == true) {
                    $("#barcode").addClass("input-warning");
                    $("#exemptfines").show();
                } else {
                    $("#barcode").removeClass("input-warning");
                    $("#exemptfines").hide();
                }
                $("#barcode").focus();
            });

            $("#dropboxcheck").change(function () {
                if (this.checked == true) {
                    $("#barcode").addClass("input-warning");
                    $("#dropboxmode").show();

                    $("#return_date_override_fields :input").prop('disabled', true);
                } else {
                    $("#barcode").removeClass("input-warning");
                    $("#dropboxmode").hide();

                    $("#return_date_override_fields :input").prop('disabled', false);
                }
                $("#barcode").focus();
            });

            $("#forgivemanualholdsexpire").change(function () {
                if (this.checked == true) {
                    $("#barcode").addClass("input-warning");
                    $("#forgivemanualholdsexpire-alert").show();
                } else {
                    $("#barcode").removeClass("input-warning");
                    $("#forgivemanualholdsexpire-alert").hide();
                }
                $("#barcode").focus();
            });

            [% IF(overduecharges) %]
                $("#barcode").focus(function () {
                    if (($("#exemptcheck").prop("checked") == true) || ($("#dropboxcheck").prop("checked") == true)) {
                        $("#barcode").addClass("input-warning");
                    } else {
                        $("#barcode").removeClass("input-warning");
                    }
                });
                $("#barcode").blur(function () {
                    $("#barcode").removeClass("input-warning");
                });
            [% END %]

            $('.openWin').on("click",function(e){
                Dopop( $(this).data("url") );
            });

            $('.submit').on("click",function(e){
                this.form.submit();
            });

            $('.cancel').on("click",function(e){
                var docancel = $("<input>").attr("type", "hidden").attr("name", "canceltransfer").val(1);
                $('#wrongtransferform').append(docancel);
                this.form.submit();
            });

            $(".print").on("click",function(e){
                this.form.print_slip.value = 1;
                let barcode = document.getElementById('confirm-hold-barcode');
                if ( barcode ) barcode.remove();
                this.form.submit();
            });

            $('.print-recall').on("click",function(e){
                this.form.recall_slip.value = 1;
                this.form.submit();
            });

            $(".approve").on("click",function(e){
                let barcode = document.getElementById('confirm-hold-barcode');
                if ( barcode ) barcode.remove();
                this.form.submit();
            });
            $(".ignore").on("click",function(e){
                e.preventDefault();
            });
            $('.cancel-hold').on("click",function(e){
                let cancel_form = document.getElementById('cancellation-reason');
                let cancel_reason = '';
                if ( cancel_form ) {
                    cancel_reason = cancel_form.value;
                }
                this.form.cancel_reserve.value = 1;
                this.form.cancel_reason.value = cancel_reason;
                this.form.submit();
            });

            $('.action').on("click",function(e){
                this.checked = false;
                this.form.return_date_override.value = '';
                this.form.return_date_override_remember.checked = false;
                this.form.barcode.focus();
                $("#return_date_remember").hide();
                return false;
            });

            $("#return_date_override_remember").on("change", function(){
                if( $(this).prop("checked" ) ){
                    if( $("#return_date_override").val() == "" ){
                        $("#saved_return_date").text( _("No date selected") );
                    } else {
                        $("#saved_return_date").text( $("#return_date_override").val() );
                    }
                    $("#return_date_remember").show();
                } else {
                    $("#return_date_remember").hide();
                }
            });

            $(".printcheckinslip").on("click", function(e){
                e.preventDefault();
                var borrowernumber = $(this).data('borrowernumber');
                window.open("/cgi-bin/koha/members/printslip.pl?borrowernumber=" + borrowernumber + "&amp;print=checkinslip", "printwindow");
            });

            // item bundles
            $('#verify-items-bundle-contents-barcodes').on('input', function (ev) {
                let char = ev.target.value.slice(-1);
                if ( char.match(/\n/) ) {
                    const barcodes = ev.target.value.split('\n').map(function(s) { return s.trim().toUpperCase() });
                    const expected = [];
                    let found = 0;
                    $('#items-bundle-contents-table tbody > tr').each(function () {
                        const barcode = this.getAttribute('data-barcode').toUpperCase();
                        expected.push(barcode);
                        if (barcodes.includes(barcode)) {
                            this.classList.add('ok');
                            found++;
                        } else {
                            this.classList.remove('ok');
                        }
                    });
                    const last = barcodes[barcodes.length -2];
                    const feedback = $('#bundle-feedback');
                    let string;
                    if ( !expected.includes(last) ) {
                        feedback.fadeOut(100, function(){
                            string = _("Unexpected: ") +last;
                            feedback.addClass('alert-danger').removeClass('alert-success').html(string).fadeIn(100);
                        });
                    } else {
                        feedback.fadeOut(100, function(){
                            string = _("Verified: ")+last;
                            feedback.addClass('alert-success').removeClass('alert-danger').html(string).fadeIn(100);
                        });
                    }
                    $('#verify-progress').show();
                    $('#verified').text(found);
                    $('#expected').text(expected.length);
                }
            });

            $('.bundle_remove').on('click', function() {
                var component_itemnumber = $(this).data('itemnumber');
                var host_itemnumber = $(this).data('hostnumber');
                var alert = $(this).closest('div');
                var unlink_item_url = "/api/v1/items/" + host_itemnumber + "/bundled_items/item/" + component_itemnumber;
                $.ajax({
                    type: "DELETE",
                    url: unlink_item_url,
                    success: function(){
                        alert.remove();
                    }
                });
            });

            $("#items-bundle-contents-table").kohaTable({
                searching: false,
                paging: false,
                info: false,
                order: [
                    [1, "asc"],
                    [0, "asc"],
                ],
            });

            [% IF ( !(Koha.Preference('TransfersBlockCirc')) && Koha.Preference('AutomaticConfirmTransfer') ) %]
                $("#wrong-transfer-modal").on('hidden.bs.modal',function(){
                    $("#wrongtransferform").submit();
                });
                [% IF (transfer) %]
                    $("#item-transfer-modal").on('hidden.bs.modal',function(){
                        $("#mainform").submit();
                    });
                [% END %]
            [% END %]
        });
    </script>
[% END %]

[% INCLUDE 'intranet-bottom.inc' %]
