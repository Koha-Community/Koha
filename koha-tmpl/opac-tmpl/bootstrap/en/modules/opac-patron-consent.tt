[% USE Koha %]
[% SET consentview = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>[% IF ( LibraryNameTitle ) %][% LibraryNameTitle | html %][% ELSE %]Koha online[% END %] catalog &rsaquo; Your consents</title>
[% INCLUDE 'doc-head-close.inc' %]
[% BLOCK cssinclude %][% END %]
</head>
[% INCLUDE 'bodytag.inc' bodyid='opac-patron-consent' %]
[% INCLUDE 'masthead.inc' %]

<div class="main">
    <ul class="breadcrumb">
        <li><a href="/cgi-bin/koha/opac-main.pl">Home</a> <span class="divider">&rsaquo;</span></li>
        <li><a href="/cgi-bin/koha/opac-user.pl">[% patron.firstname | html %] [% patron.surname | html %]</a> <span class="divider">&rsaquo;</span></li>
        <li><a href="#">Your consents</a></li>
    </ul>

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span2">
                <div id="navigation">
                    [% INCLUDE 'navigation.inc' IsPatronPage=1 %]
                </div>
            </div>
            <div class="span10">
                <div id="patronconsents">

                    [% IF Koha.Preference('GDPR_Policy') %]
                    <div class="alert">
                            <p>In order to keep you logged in, we need your consent to process personal data as specified in the EU General Data Protection Regulation of May 25, 2018.</p>
                            <p>Please save your consent below or log out. Thank you!</p>
                    </div>
                    [% END %]

                    <h3>Your consents</h3>

                    <form action="/cgi-bin/koha/opac-patron-consent.pl" method="post">
                        [% IF Koha.Preference('GDPR_Policy') %]
                            <h5>GDPR consents</h5>
                            <input type="hidden" name="op" value="gdpr_proc_save"/>
                            <input type="hidden" name="borrowernumber" value="[% patron.borrowernumber | html %]"/>
                            <fieldset>
                                <ul><li>
                                    <p>I have read the <a target="_blank" href="[% Koha.Preference('PrivacyPolicyURL') | url %]">privacy policy</a> and agree with your processing of my personal data as outlined therein.</p>
                                    <p><input type="radio" name="gdpr_processing" value="agreed"> Yes, I agree.<br>
                                    <input type="radio" name="gdpr_processing" value="disagreed"> No, I do not agree. Please remove my account within a reasonable time.</p>
                                    [% IF gdpr_proc_consent %]
                                        <p>Your consent was registered on [% gdpr_proc_consent | html %].</p>
                                    [% END %]
                                </li></ul>
                            </fieldset>
                            <fieldset class="action"><input id="saveconsent" type="submit" value="Save" class="btn" /></fieldset>
                        [% END %]

                    </form>

                </div> <!-- / #userpasswd -->
            </div> <!-- / .span10 -->
        </div> <!-- / .row-fluid -->
    </div> <!-- / .container-fluid -->
</div> <!-- / .main -->

[% INCLUDE 'opac-bottom.inc' %]
[% BLOCK jsinclude %]
<script type="text/javascript">
    var consent = null;
    $(document).ready(function() {
        [% IF gdpr_proc_consent %]
            consent=1;
            $("input[type='radio'][value='agreed']").prop('checked',true);
            $(".alert").hide();
        [% ELSIF gdpr_proc_refusal %]
            consent=0;
            $("input[type='radio'][value='disagreed']").prop('checked',true);
        [% ELSE %]
        [% END %]
        $("#saveconsent").prop('disabled', true);

        $("input[type='radio']").click(function() {
            var radio = $(this).val();
            if(radio=='agreed' && (consent==null || consent==0)) $("#saveconsent").prop('disabled', false);
            if(radio=='disagreed' && (consent==null || consent==1)) $("#saveconsent").prop('disabled', false);
            if(radio=='agreed') $(".alert").hide();
            if(radio=='disagreed') $(".alert").show();
        });

    });
</script>
[% END %]
