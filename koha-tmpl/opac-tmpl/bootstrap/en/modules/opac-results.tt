[% USE raw %]
[% USE Asset %]
[% USE Koha %]
[% USE KohaPlugins %]
[% USE To %]
[% SET LoginEnabled = ( Koha.Preference('opacuserlogin') == 1 ) %]
[% IF ( Koha.Preference('TagsEnabled') ) %]
    [% SET TagsShowEnabled = ( ( Koha.Preference('TagsEnabled') == 1 ) && ( Koha.Preference('TagsShowOnList') > 0 ) ) %]
    [% SET TagsInputEnabled = LoginEnabled && TagsShowEnabled && ( Koha.Preference('TagsInputOnList') > 0 ) %]
[% END %]
[% SET CartEnabled = ( Koha.Preference('opacbookbag') == 1 ) %]
[% SET ListsEnabled = ( Koha.Preference('virtualshelves') == 1 ) && LoginEnabled %]
[% SET HoldsEnabled = ( Koha.Preference('OPACHoldRequests') == 1 ) && LoginEnabled %]
[% SET RecallsEnabled = ( Koha.Preference('UseRecalls') == 1 ) && LoginEnabled %]
[% SET ArticleRequestsEnabled = ( Koha.Preference('ArticleRequests') == 1 ) && LoginEnabled %]
[% SET MultiHolds = ( Koha.Preference('DisplayMultiPlaceHold') == 1 ) && HoldsEnabled %]
[% SET CoverImagePlugins = KohaPlugins.get_plugins_opac_cover_images %]
[% SET OPACLocalCoverImages = Koha.Preference('OPACLocalCoverImages') %]
[% SET OPACAmazonCoverImages = Koha.Preference('OPACAmazonCoverImages') %]
[% SET SyndeticsCoverImages = ( Koha.Preference('SyndeticsEnabled') && Koha.Preference('SyndeticsCoverImages') ) %]
[% SET GoogleJackets = Koha.Preference('GoogleJackets') %]
[% SET OpenLibraryCovers = Koha.Preference('OpenLibraryCovers') %]
[% SET BakerTaylorEnabled = Koha.Preference('BakerTaylorEnabled') %]
[% SET OPACCoce = ( Koha.Preference('OPACCoce') && Koha.Preference('CoceProviders') ) %]
[% IF ( CoverImagePlugins || OPACLocalCoverImages || OPACAmazonCoverImages || SyndeticsCoverImages || GoogleJackets || OpenLibraryCovers || BakerTaylorEnabled || OPACCoce || OPACCustomCoverImages ) %]
    [% SET CoverImages = 1 %]
    [% SET OPACCustomCoverImages = ( Koha.Preference('OPACCustomCoverImages') && Koha.Preference('CustomCoverImagesURL') ) %]
    [% SET OverDriveEnabled = Koha.Preference('OverDriveLibraryID') && Koha.Preference('OverDriveClientKey') && Koha.Preference('OverDriveClientSecret') %]
[% END %]
[% SET OverDriveEnabled = ( Koha.Preference( "OPACOverDrive" ) && Koha.Preference('OverDriveLibraryID') && Koha.Preference('OverDriveClientKey') && Koha.Preference('OverDriveClientSecret') ) %]

[% INCLUDE 'doc-head-open.inc' %]
<title>
    [% IF ( searchdesc ) %]
        [% IF ( ms_value ) %]
            Results of search for '[% ms_value | html %]'
        [% ELSE %]
            Search results
        [% END %]
    [% ELSE %]
        You did not specify any search criteria.
    [% END %]
    &rsaquo; [% IF ( LibraryNameTitle ) %][% LibraryNameTitle | html %][% ELSE %]Koha online[% END %] catalog
</title>
<meta name="robots" content="noindex" />
[% Asset.css("lib/Chocolat/css/chocolat.css") | $raw %]
[% INCLUDE 'doc-head-close.inc' %]
[% BLOCK cssinclude %]
[% END %]

<link
    rel="alternate"
    type="application/rss+xml"
    title="[% LibraryName | html %] Search RSS feed"
    href="[% OPACBaseURL | url %]/cgi-bin/koha/opac-search.pl?[% query_cgi | $raw %][% limit_cgi | $raw %]&amp;count=[% countrss |uri %]&amp;sort_by=acqdate_dsc&amp;format=rss"
/>
</head>
[% INCLUDE 'bodytag.inc' bodyid='results' bodyclass='scrollto' %]
[% INCLUDE 'masthead.inc' %]

<main class="main">
    [% WRAPPER breadcrumbs %]
        [% IF ( searchdesc ) %]
            [% IF ( ReturnPath ) %]
                [% WRAPPER breadcrumb_item %]
                    <a href="[% ReturnPath | url %]">Advanced search</a>
                [% END %]
            [% ELSE %]
                [% WRAPPER breadcrumb_item %]
                    <a href="/cgi-bin/koha/opac-search.pl">Advanced search</a>
                [% END %]
            [% END %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                [% IF ( ms_value ) %]
                    <span title="You searched [% IF ( query_desc ) %]for '[% query_desc | html %]'[% END %][% IF ( limit_desc ) %]with limit(s): '[% limit_desc | html %]'[% END %]"
                        >Results of search for '[% ms_value | html %]'[% IF ( pages > 1) %], page [% current_page_number | html %] of [% pages | html %][% END %]</span
                    >
                [% ELSE %]
                    <span title="You searched [% IF ( query_desc ) %]for '[% query_desc | html %]'[% END %][% IF ( limit_desc ) %]with limit(s): '[% limit_desc | html %]'[% END %]">Search results</span>
                [% END %]
            [% END %]
        [% ELSE %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                <span>You did not specify any search criteria</span>
            [% END %]
        [% END %]
    [% END #/ WRAPPER breadcrumbs %]

    [% UNLESS ( total ) %]
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h1 id="numresults">No results found!</h1>
                    <p>
                        [% IF ( searchdesc ) %]
                            No results found for that in [% LibraryName | html %] catalog.
                            <a
                                href="[% OPACBaseURL | url %]/cgi-bin/koha/opac-search.pl?[% query_cgi | $raw %][% limit_cgi | $raw %]&amp;count=[% countrss |uri %]&amp;sort_by=acqdate_dsc&amp;format=rss"
                                aria-label="Subscribe to this search"
                                class="btn btn-link rsssearchlink noprint"
                            >
                                <i class="fa fa-rss rsssearchicon" aria-hidden="true" title="Subscribe to this search"></i>
                            </a>
                        [% ELSE %]
                            You did not specify any search criteria.
                        [% END %]
                    </p>
                    [% IF ( ReturnPath ) %]
                        <div class="returntosearch">
                            <p><a href="[% ReturnPath | url %]">Return to the last advanced search</a></p>
                        </div>
                    [% END %]
                    [% IF ( OPACNoResultsFound ) %]
                        <div id="noresultsfound"> [% OPACNoResultsFound | $raw %] </div>
                    [% END %]
                </div>
                <!-- / .col -->
            </div>
            <!-- / .row -->
        </div>
        <!-- / .container-fluid -->
    [% END # / UNLESS searchdesc %]

    <div class="container-fluid">
        <div class="row">
            [% IF ( opacfacets && total ) %]
                <div class="col-lg-2">
                    <div id="facetcontainer">
                        <!-- FACETS START -->
                        [% INCLUDE 'opac-facets.inc' %]
                        <!-- FACETS END -->
                    </div>
                </div>
            [% END %]

            [% SET column_class = "col maincontent" %]
            [% IF ( opacfacets ) %]
                [% column_class = "col-lg-10 maincontent" %]
            [% END %]
            <div class="[% column_class | html %]">
                [% IF ( searchdesc ) %]
                    [% IF ( total ) %]
                        <h1 id="numresults">
                            Your search returned [% total | html %] results.
                            <a
                                href="[% OPACBaseURL | url %]/cgi-bin/koha/opac-search.pl?[% query_cgi | $raw %][% limit_cgi | $raw %]&amp;count=[% countrss |uri %]&amp;sort_by=acqdate_dsc&amp;format=rss"
                                class="btn btn-link rsssearchlink noprint"
                                aria-label="Subscribe to this search"
                            >
                                <i class="fa fa-rss rsssearchicon" aria-hidden="true" title="Subscribe to this search"></i>
                            </a>
                        </h1>
                        [% IF ( related ) %]
                            <p>(related searches:[% FOREACH relate IN related %][% relate.related_search | html %][% END %]).</p>
                        [% END %]
                    [% END # / IF total %]
                [% END # / IF searchdesc %]

                <div id="userresults">
                    [% IF ( DidYouMean ) %]
                        <div id="didyoumean">Not what you expected? Check for <a href="/cgi-bin/koha/svc/suggestion?render=standalone&amp;q=[% querystring | uri %]">suggestions</a></div>
                    [% END %]

                    [% IF ( total ) %]
                        [% IF ( ReturnPath ) %]
                            <div class="returntosearch">
                                <p><a href="[% ReturnPath | url %]">Return to the last advanced search</a></p>
                            </div>
                        [% END %]
                    [% END %]
                    [% IF ( query_error ) %]
                        <div class="alert alert-warning">
                            <h2>Error:</h2>
                            [% query_error | html %]
                        </div>
                    [% END %]

                    <!-- Search Results Table -->
                    [% IF ( total ) %]
                        <div class="searchresults">
                            <form action="/cgi-bin/koha/opac-search.pl" method="get" name="bookbag_form" id="bookbag_form">
                                <legend class="sr-only">Sort</legend>
                                [% IF ( searchdesc ) %]
                                    [% FOREACH QUERY_INPUT IN QUERY_INPUTS %]
                                        <input type="hidden" name="[% QUERY_INPUT.input_name | html %]" value="[% QUERY_INPUT.input_value | html %]" />
                                    [% END %]
                                    [% FOREACH LIMIT_INPUT IN LIMIT_INPUTS %]
                                        <input type="hidden" name="[% LIMIT_INPUT.input_name | html %]" value="[% LIMIT_INPUT.input_value | html %]" />
                                    [% END %]
                                [% END # IF /searchdesc %]

                                <div id="floating" class="sticky">
                                    <div id="toolbar" class="toolbar row align-items-center">
                                        <div id="top-pages" class="col"> [% INCLUDE 'page-numbers.inc' %] </div>
                                        [% UNLESS tag %]
                                            <div class="sort_by col-sm-auto">
                                                <label for="sort_by" class="sr-only">Sort by:</label>
                                                <select id="sort_by" class="resort form-select form-select-sm" name="sort_by">
                                                    [% INCLUDE 'resort_form.inc' %]
                                                </select>

                                                [% IF Koha.Preference('OPACnumSearchResultsDropdown') %]
                                                    <label for="results_per_page">Results per page: </label>
                                                    <select id="results_per_page" class="form-select" name="count">
                                                        [% IF Koha.Preference('OPACnumSearchResults') %]
                                                            [% IF results_per_page == Koha.Preference('OPACnumSearchResults') %]
                                                                <option value="[% Koha.Preference('OPACnumSearchResults') | html %]" selected="selected">[% Koha.Preference('OPACnumSearchResults') | html %] (default)</option>
                                                            [% ELSE %]
                                                                <option value="[% Koha.Preference('OPACnumSearchResults') | html %]">[% Koha.Preference('OPACnumSearchResults') | html %] (default)</option>
                                                            [% END %]
                                                        [% END %]
                                                        [% IF results_per_page == '20' %]<option value="20" selected="selected">20</option>[% ELSE %]<option value="20">20</option>[% END %]
                                                        [% IF results_per_page == '40' %]<option value="40" selected="selected">40</option>[% ELSE %]<option value="40">40</option>[% END %]
                                                        [% IF results_per_page == '60' %]<option value="60" selected="selected">60</option>[% ELSE %]<option value="60">60</option>[% END %]
                                                        [% IF results_per_page == '80' %]<option value="80" selected="selected">80</option>[% ELSE %]<option value="80">80</option>[% END %]
                                                        [% IF results_per_page == '100' %]<option value="100" selected="selected">100</option>[% ELSE %]<option value="100">100</option>[% END %]
                                                    </select>
                                                [% END # IF Koha.Preference('OPACnumSearchResultsDropdown') %]
                                            </div>
                                            <!-- /.sort_by -->
                                            <div id="sortsubmit" class="sort_by col-auto">
                                                <input type="submit" class="btn btn-primary btn-sm clearfix" value="Go" />
                                            </div>
                                            <!-- /.sort_by -->
                                        [% END # /UNLESS tag %]
                                    </div>
                                    <!-- / #toolbar -->

                                    [% INCLUDE 'result-batch-controls.inc' results=1 %]
                                </div>
                                <!-- /#floating -->

                                <!-- TABLE RESULTS START -->
                                <table class="table table-striped">
                                    <caption class="sr-only">Results</caption>

                                    <!-- Actual Search Results -->
                                    [% FOREACH SEARCH_RESULT IN SEARCH_RESULTS %]
                                        <tr>
                                            [%# Cell 1: Checkbox %]
                                            [% IF ( SEARCH_RESULT.title ) %]
                                                [% check_title = SEARCH_RESULT.title %]
                                            [% ELSE %]
                                                [% check_title = SEARCH_RESULT.biblionumber %]
                                            [% END %]
                                            <td class="selectcol">
                                                [% IF Koha.Preference( 'opacbookbag' ) == 1 %]
                                                    <input
                                                        type="checkbox"
                                                        class="cb"
                                                        id="bib[% SEARCH_RESULT.biblionumber | html %]"
                                                        name="biblionumber"
                                                        value="[% SEARCH_RESULT.biblionumber | html %]"
                                                        aria-label="Select search result: [% check_title | html %]"
                                                    />
                                                    <label for="bib[% SEARCH_RESULT.biblionumber | html %]"></label>
                                                [% ELSE %]
                                                    [% IF Koha.Preference( 'virtualshelves' ) == 1 %]
                                                        <input
                                                            type="checkbox"
                                                            class="cb"
                                                            id="bib[% SEARCH_RESULT.biblionumber | html %]"
                                                            name="biblionumber"
                                                            value="[% SEARCH_RESULT.biblionumber | html %]"
                                                            aria-label="Select search result: [% check_title | html %]"
                                                        />
                                                        <label for="bib[% SEARCH_RESULT.biblionumber | html %]"></label>
                                                    [% ELSE %]
                                                        [% IF Koha.Preference( 'OPACHoldRequests' ) == 1 %]
                                                            [% UNLESS ( SEARCH_RESULT.norequests ) %]
                                                                [% IF Koha.Preference( 'opacuserlogin' ) == 1 %]
                                                                    <input
                                                                        type="checkbox"
                                                                        class="cb"
                                                                        id="bib[% SEARCH_RESULT.biblionumber | html %]"
                                                                        name="biblionumber"
                                                                        value="[% SEARCH_RESULT.biblionumber | html %]"
                                                                        aria-label="Select search result: [% check_title | html %]"
                                                                    />
                                                                    <label for="bib[% SEARCH_RESULT.biblionumber | html %]"></label>
                                                                [% END %]
                                                            [% END %]
                                                        [% END # IF OPACHoldRequests %]
                                                    [% END # IF virtualshelves %]
                                                [% END # IF opacbookbag %]
                                            </td>

                                            [%# Cell 2: Show result number if OpacHiddenItems is empty %]
                                            <td class="numcol[%- IF suppress_result_number -%]hidden[%- END -%]">
                                                [% UNLESS suppress_result_number %]
                                                    [% SEARCH_RESULT.result_number | html %].
                                                [% END %]
                                            </td>

                                            [% IF ( !item_level_itypes || Koha.Preference('BiblioItemtypeInfo') ) && !Koha.Preference('OpacNoItemTypeImages') %]
                                                [%# Cell 3: Show item type image %]
                                                <td class="itypecol">
                                                    [% IF ( SEARCH_RESULT.imageurl ) %]
                                                        <img class="itemtype-image" src="[% SEARCH_RESULT.imageurl | html %]" title="[% SEARCH_RESULT.description | html %]" alt="[% SEARCH_RESULT.description | html %]" />
                                                    [% END %]
                                                    [% IF ( SEARCH_RESULT.score_avg ) %]
                                                        <img src="[% themelang | html %]/../images/bonus.png" title="bonus" style="max-height: 35px;" />
                                                    [% END %]
                                                </td>
                                            [% END %]
                                            [% IF ( CoverImages) %]
                                                <td class="covercol"> [% INCLUDE 'cover-images.inc' %] </td>
                                            [% END %]
                                            [%# Cell 4: Search result details and controls %]
                                            <td class="bibliocol">
                                                [% IF ( COinSinOPACResults && SEARCH_RESULT.coins ) %]
                                                    <!-- COinS / Openurl -->
                                                    <span class="Z3988" title="[% SEARCH_RESULT.coins | html %]"></span>
                                                [% END %]
                                                <div id="title_summary_[% SEARCH_RESULT.biblionumber | html %]" class="title_summary">
                                                    [% SEARCH_RESULT.XSLTResultsRecord | $raw %]

                                                    [% IF ( SEARCH_RESULT.score_avg ) %]
                                                        <div class="results_summary">
                                                            [% FOREACH i  IN [ 1 2 3 4 5  ] %]
                                                                [% IF ( SEARCH_RESULT.score_int >= i ) %]
                                                                    <div class="star-rating rater-[% i | html %] star star-rating-applied star-rating-readonly star-rating-on"><a title="[% i | html %]">[% i | html %]</a></div>
                                                                [% ELSE %]
                                                                    <div class="star-rating rater-[% i | html %] star star-rating-applied star-rating-readonly"><a title="[% i | html %]">[% i | html %]</a></div>
                                                                [% END %]
                                                            [% END %]
                                                            <span id="babeltheque-rating_total_[% SEARCH_RESULT.biblionumber | html %]"
                                                                >&nbsp;&nbsp; [% SEARCH_RESULT.score_avg | html %] / 5 (on [% SEARCH_RESULT.num_scores | html %] rates)</span
                                                            >

                                                            [% IF ( SEARCH_RESULT.num_critics ) %]
                                                                <span class="social_data">[% SEARCH_RESULT.num_critics | html %] Internet user critics</span>
                                                            [% END %]
                                                            [% IF ( SEARCH_RESULT.num_critics_pro ) %]
                                                                <span class="social_data">[% SEARCH_RESULT.num_critics_pro | html %] Professional critics</span>
                                                            [% END %]
                                                            [% IF ( SEARCH_RESULT.num_videos ) %]
                                                                <span class="social_data">[% SEARCH_RESULT.num_videos | html %] Video extracts</span>
                                                            [% END %]
                                                            [% IF ( SEARCH_RESULT.num_quotations ) %]
                                                                <span class="social_data">[% SEARCH_RESULT.num_quotations | html %] Quotations</span>
                                                            [% END %]
                                                        </div>
                                                        <!-- / .results_summary -->
                                                    [% END # / IF SEARCH_RESULT.score_avg %]

                                                    [% IF ( LibraryThingForLibrariesID ) %]
                                                        <div class="ltfl_reviews"></div>
                                                    [% END %]

                                                    [% IF ( TagsShowEnabled && SEARCH_RESULT.TagLoop.size ) %]
                                                        <div class="results_summary tags">
                                                            <span class="label">Tags:</span>
                                                            <ul>
                                                                [% FOREACH TagLoo IN SEARCH_RESULT.TagLoop %]
                                                                    <li>
                                                                        <a href="/cgi-bin/koha/opac-search.pl?tag=[% TagLoo.term | uri %]&amp;q=[% TagLoo.term | uri %]">[% TagLoo.term | html %]</a>
                                                                        <span class="weight">([% TagLoo.weight_total | html %])</span>
                                                                    </li>
                                                                [% END %]
                                                            </ul>
                                                        </div>
                                                    [% END %]

                                                    [% IF Koha.Preference('virtualshelves') AND SEARCH_RESULT.shelves.count %]
                                                        <div class="results_summary shelves">
                                                            <span class="label">Lists:</span>
                                                            <ul>
                                                                [% FOREACH shelf IN SEARCH_RESULT.shelves %]
                                                                    <li>
                                                                        <a href="/cgi-bin/koha/opac-shelves.pl?op=view&amp;shelfnumber=[% shelf.shelfnumber | uri %]">[% shelf.shelfname | html %]</a>
                                                                        [%~ UNLESS loop.last %],[% ELSE %].[% END ~%]
                                                                    </li>
                                                                [% END %]
                                                            </ul>
                                                        </div>
                                                    [% END %]

                                                    [% IF ( SEARCH_RESULT.searchhighlightblob ) %]
                                                        <span class="results_summary">
                                                            <span class="label">Match:</span>
                                                            [% SEARCH_RESULT.searchhighlightblob | html %]
                                                        </span>
                                                    [% END %]

                                                    [% INCLUDE "openlibrary-readapi.inc" bib = SEARCH_RESULT %]

                                                    [% IF ( OpacStarRatings == 'all' ) %]
                                                        <div class="results_summary ratings">
                                                            [% SET rating_avg = SEARCH_RESULT.ratings.get_avg_rating() %]
                                                            [% rating_avg_int = BLOCK %][% rating_avg | format("%.0f") %][% END %]
                                                            <div class="br-wrapper br-theme-fontawesome-stars">
                                                                <div class="br-widget br-readonly">
                                                                    [% FOREACH i IN [ 1 2 3 4 5  ] %]
                                                                        [% IF rating_avg_int == i %]
                                                                            <a href="#" class="br-selected br-current"></a>
                                                                        [% ELSIF rating_avg_int > i %]
                                                                            <a href="#" class="br-selected"></a>
                                                                        [% ELSE %]
                                                                            <a href="#"></a>
                                                                        [% END %]
                                                                    [% END %]
                                                                </div>
                                                            </div>

                                                            [% IF SEARCH_RESULT.ratings.count > 0 %]
                                                                <span id="rating_total_[% SEARCH_RESULT.biblionumber | html %]">&nbsp;&nbsp;([% SEARCH_RESULT.ratings.count | html %] votes)</span>
                                                            [% ELSE %]
                                                                <br />
                                                            [% END %]
                                                        </div>
                                                        <!-- / .results_summary -->
                                                    [% END # / IF OpacStarRatings %]

                                                    [% INCLUDE 'title-actions-menu.inc' items=SEARCH_RESULT %]
                                                </div>
                                            </td>
                                        </tr>
                                    [% END # / FOREACH SEARCH_RESULT %]
                                </table>
                            </form>
                            <!-- / #bookbag_form -->

                            <form id="hold_form" name="hold_form" method="get" action="/cgi-bin/koha/opac-reserve.pl">
                                <!-- The value will be set by holdBiblioNums() in basket.js -->
                                <input id="hold_form_biblios" type="hidden" name="biblionumbers" value="" />
                            </form>
                        </div>
                        <!-- / .searchresults -->

                        <div id="bottom-pages">[% INCLUDE 'page-numbers.inc' %]</div>
                    [% END # / IF total %]

                    [%# Display "Not finding what you're looking for" for suggestion or ILL %]
                    [% IF Koha.Preference( 'suggestion' ) || Koha.Preference( 'ILLModule' ) %]
                        <div class="suggestion">
                            Not finding what you're looking for?
                            <ul>
                                [% IF Koha.Preference( 'suggestion' ) %]
                                    <li>Make a <a href="/cgi-bin/koha/opac-suggestions.pl?op=add_form">purchase suggestion</a></li>
                                [% END %]
                                [% IF Koha.Preference( 'ILLModule' ) %]
                                    [% IF Koha.Preference( 'AutoILLBackendPriority' ) %]
                                        <li>Make an <a href="/cgi-bin/koha/opac-illrequests.pl?op=create&amp;backend=Standard">interlibrary loan request</a></li>
                                    [% ELSE %]
                                        <li>Make an <a href="/cgi-bin/koha/opac-illrequests.pl?op=create">interlibrary loan request</a></li>
                                    [% END %]
                                [% END %]
                            </ul>
                        </div>
                    [% END %]
                </div>
                <!-- / #userresults -->
            </div>
            <!-- /.span10/12 -->
        </div>
        <!-- / .row -->
    </div>
    <!-- / .container-fluid --> </main
><!-- / .main -->

[% INCLUDE 'opac-bottom.inc' %]
[% BLOCK jsinclude %]
    [% IF ( LibraryThingForLibrariesID ) %]
        <script src="https://ltfl.librarything.com/forlibraries/widget.js?id=[% LibraryThingForLibrariesID | html %]&amp;systype=koha">
</script>
    [% END %]
    [% IF ( OverDriveEnabled ) %][% Asset.js("js/overdrive.js") | $raw %][% END %]
    [% Asset.js("js/authtoresults.js") | $raw %]
    [% IF ( OpacHighlightedWords ) %]
        [% Asset.js("lib/jquery/plugins/jquery.highlight-5.js") | $raw %]
    [% END %]
    [% IF OpenLibraryCovers || OpenLibrarySearch %]
        [% Asset.js("js/openlibrary.js") | $raw %]
    [% END %]
    [% Asset.js("lib/Chocolat/js/chocolat.js") | $raw %]
    [% CoverImagePlugins | $raw %]
    <script>
        const loggedinusername = [% ( loggedinusername ) ? 1 : 0 | html %];
        const opacbookbag = [% ( opacbookbag ) ? 1 : 0 | html %];
        const virtualshelves = [% ( virtualshelves ) ? 1 : 0 | html %];
    </script>
    [% Asset.js("js/results-list.js") | $raw %]
    <script>
        [% IF ( OpacHighlightedWords ) %]
            var q_array = new Array();  // holds search terms if available

            function highlightOff() {
                $("td").removeHighlight();
                $(".highlight_toggle").toggle();
            }
            function highlightOn() {
                var x;
                for (x in q_array) {
                    q_array[x] = q_array[x].replace(/\w*:([\w])/, "$1");
                    q_array[x] = q_array[x].toLowerCase();
                    var myStopwords = "[% Koha.Preference('NotHighlightedWords') | html %]".toLowerCase().split('|');
                    if ( (q_array[x].length > 0) && ($.inArray(q_array[x], myStopwords) == -1) ) {
                        $(".title").highlight(q_array[x]);
                        $(".author").highlight(q_array[x]);
                        $(".results_summary").highlight(q_array[x]);
                    }
                }
                $(".highlight_toggle").toggle();
            }
        [% END # /IF OpacHighlightedWords %]

        function verify_cover_images() {
            // Loop over each container in the template which contains covers
            $(".cover-slider").each(function( index ){
                let biblionumber = $(this).data("biblionumber");
                let booktitle = $(this).data("title");
                var lightbox_descriptions = [];
                $(this).find(".cover-image").each( function( index ){
                    var div = $(this);
                    // Find the image in the container
                    var img = div.find("img")[0];
                    if( img && $(img).length > 0 ){
                        // All slides start hidden. If this is the first one, show it.
                        // Check if Amazon image is present
                        if ( div.hasClass("amazon-coverimg") ) {
                            let w = img.width;
                            let h = img.height;
                            if ((w == 1) || (h == 1)) {
                                // Amazon returned single-pixel placeholder
                                // Remove the container
                                div.remove();
                            } else {
                                lightbox_descriptions.push(_("Amazon cover image (<a href='%s'>see the original image</a>)").format($(img).data('link')));
                            }
                        } else if( div.hasClass("custom-coverimg") ){

                            if ( (img.complete != null) && (!img.complete) || img.naturalHeight == 0 ) {
                                // No image was loaded via the CustomCoverImages system preference
                                // Remove the container
                                div.remove();
                            } else {
                                lightbox_descriptions.push(_("Custom cover image"));
                            }
                        } else if( div.hasClass("syndetics-coverimg") ){
                            lightbox_descriptions.push(_("Image from Syndetics"))
                        } else if( div.hasClass("googlejacket-coverimg" ) ){
                            if( img.naturalHeight  ){
                                lightbox_descriptions.push(_("Image from Google Books (<a href='%s'>see the original image</a>)").format($(img).data('link')));
                            }
                        } else if( div.hasClass("openlibrary-coverimg") ){
                            lightbox_descriptions.push(_("Image from OpenLibrary (<a href='%s'>see the original image</a>)").format($(img).data('link')));
                        } else if( div.hasClass("coce-coverimg" ) ){
                            // Identify which service's image is being loaded by Coce
                            var coce_description;
                            let src = $(img).attr("src");
                            if( src.indexOf('amazon.com') >= 0 ){
                                coce_description = _("Coce image from Amazon.com");
                            } else if( src.indexOf('google.com') >= 0 ){
                                coce_description = _("Coce image from Google Books");
                            } else if( src.indexOf('openlibrary.org') >= 0 ){
                                coce_description = _("Coce image from Open Library");
                            }
                            div.find(".hint").html(coce_description);
                            lightbox_descriptions.push(coce_description);
                        } else if ( div.hasClass("bakertaylor-coverimg" ) ){
                            lightbox_descriptions.push(_("Image from Baker &amp; Taylor"));
                        } else if ( div.hasClass("cover-image local-coverimg" ) ){
                            lightbox_descriptions.push(_("Local cover image"));
                        } else {
                            lightbox_descriptions.push(_("Cover image source unknown"));
                        }
                    } else {
                        div.remove();
                    }
                });

                // Lightbox for cover images
                Chocolat(this.querySelectorAll('.cover-image a'), {
                    description: function(){
                        return lightbox_descriptions[this.settings.currentImageIndex];
                    }
                });

            });

            $(".cover-slider").each(function(){
                var coverSlide = this;
                var coverImages = $(this).find(".cover-image");
                if( coverImages.length > 1 ){
                    coverImages.each(function( index ){
                        // If more that one image is present, add a navigation link
                        // for activating the slide
                        var covernav = $("<a href=\"#\" data-num=\"" + index + "\" class=\"cover-nav\"></a>");
                        if( index == 0 ){
                            // Set the first navigation link as active
                            $(covernav).addClass("nav-active");
                        }
                        $(covernav).html("<i class=\"fa fa-circle\"></i>");
                        $(coverSlide).append( covernav );
                    });
                }

                $(coverSlide).find(".cover-image").eq(0).show();

                if( $(coverSlide).find(".cover-image").length < 1 ){
                    $(coverSlide).remove();
                } else {
                    // This is a suboptimal workaround; we should do this via load, but
                    // the image code is scattered all over now. We come here now after
                    // window load and wait_for_images (so load completed).
                    var check_complete = 1;
                    $(coverSlide).find("img").each( function() {
                        if( !this.complete || this.naturalHeight == 0 ) check_complete = 0;
                    });
                    if( check_complete ) $(coverSlide).removeClass('cover-slides');
                }
            });

            $(".cover-slider").on("click",".cover-nav", function(e){
                e.preventDefault();
                var cover_slider = $(this).parent();
                // Adding click handler for cover image navigation links
                var num = $(this).data("num");
                $(cover_slider).find(".cover-nav").removeClass("nav-active");
                $(this).addClass("nav-active");
                $(cover_slider).find(".cover-image").hide();
                $(cover_slider).find(".cover-image").eq( num ).show();
            });

            $("#editions img").each(function(i){
                if ( this.src.indexOf('amazon.com') >= 0 ) {
                    let w = this.width;
                    let h = this.height;
                    if ((w == 1) || (h == 1)) {
                        this.src = 'https://images-na.ssl-images-amazon.com/images/G/01/x-site/icons/no-img-sm.gif';
                    } else if ( (this.complete != null) && (!this.complete) || this.naturalHeight == 0 ) {
                        this.src = 'https://images-na.ssl-images-amazon.com/images/G/01/x-site/icons/no-img-sm.gif';
                    }
                }
            });
        } /* /verify_images */


        let counter_wait = 0;
        function wait_for_images(cb){

            var loaded = 1;
            counter_wait++;

            [% IF GoogleJackets %]
                if ( loaded ) {
                    loaded = KOHA.Google.done;
                }
            [% END %]

            [% IF OpenLibraryCovers %]
                if ( loaded ) {
                    loaded = KOHA.OpenLibrary.done;
                }
            [% END %]

            [% IF ( Koha.Preference('OpacCoce') && Koha.Preference('CoceProviders') ) %]
                if ( loaded ) {
                    loaded = KOHA.coce.done;
                }
            [% END %]

            if (!loaded && counter_wait < 50) {// Do not wait more than 5 seconds
                window.setTimeout(function(){wait_for_images(cb);}, 100);
            } else {
                if (counter_wait >= 50 ) {
                }
                cb();
            }
        }

        $(window).load(function() {
            wait_for_images(verify_cover_images);
        });

        $(document).ready(function(){

            $(".moretoggle").click(function(e){
                e.preventDefault();
                $(this).siblings(".collapsible-facet").toggle();
                $(this).siblings(".moretoggle").toggle();
                $(this).toggle();
            });

            [% IF ( OpacHighlightedWords ) %]
                $('a.title').each(function() {
                    $(this).attr("href", $(this).attr("href") + "&query_desc=[% query_desc | uri %]");
                });
            [% END %]

            $(".br-readonly a").on("click", function(e){
                e.preventDefault();
            });

            $('.resort').change(function() {
                $('#bookbag_form').submit();
            });

            $('#results_per_page').change(function() {
                $('#bookbag_form').submit();
            });

            [% IF ( query_desc ) %]
                [% IF ( OpacHighlightedWords ) %]
                    q_array = query_desc.split(" ");
                    // ensure that we don't have "" at the end of the array, which can
                    // break the highlighter
                    while (q_array.length > 0 && q_array[q_array.length-1] == "") {
                        q_array = q_array.splice(0,-1);
                    }
                    highlightOn();
                    $("#highlight_toggle_on" ).hide().click(function(e) {
                        e.preventDefault();
                        highlightOn();
                    });
                    $("#highlight_toggle_off").show().click(function(e) {
                        e.preventDefault();
                        highlightOff();
                    });
                [% END # /IF OpacHighlightedWords %]
                [% IF ( OverDriveEnabled && firstPage ) %]
                    var $overdrive_results = $( '<div id="overdrive-results">' + _("Searching %s...").format('OverDrive') + ' <img class="throbber" src="[% interface | html %]/[% theme | html %]/images/spinner-small.gif" /></div>' );
                    $( '#numresults' ) .after( $overdrive_results );
                    //Clean querystring, first we remove CCL entities, then decode HTML entities, then swap double quotes for single quotes
                    //as the overdrive API treats double quotes as a search term and returns extra results
                    od_querystring = querystring.replace(/(?:^|\W)([\w-]+)(,[\w-]+)*([:=])/g,' ');
                    od_querystring = new DOMParser().parseFromString( od_querystring, 'text/html').body.innerText;
                    od_querystring = od_querystring.replace(/\"/g,"'");
                    KOHA.OverDrive.Search( "[% Koha.Preference('OverDriveLibraryID') | html %]", od_querystring, 1, 0, function( data ) {
                        if ( data.error ) {
                            $overdrive_results.html( _("Error searching %s collection").format('OverDrive') );
                            return;
                        }

                        if ( data.totalItems ) {
                            $overdrive_results.html( '<a href="/cgi-bin/koha/opac-overdrive-search.pl?q=' + encodeURIComponent( od_querystring ) + '">' + _("Found %s results in the library's %s collection").format(data.totalItems, 'OverDrive') + '</a>' );
                        } else {
                            $overdrive_results.remove();
                        }
                    } );
                [% END # /IF OverDriveEnabled %]
                [% IF ( OpenLibrarySearch ) %]
                    var $openlibrary_results = $( '<div id="openlibrary-results">' + _("Searching %s...").format('OpenLibrary' ) + ' <img class="throbber" src="[% interface | html %]/[% theme | html %]/images/spinner-small.gif" /></div>' );
                    $( '#numresults' ) .after( $openlibrary_results );
                    KOHA.OpenLibrary.search( querystring, null, function( data ) {
                        if ( data.error ) {
                            $openlibrary_results.html( _("Error searching %s collection").format('OpenLibrary') );
                            return;
                        }

                        if ( data.numFound > 0 ) {
                            $openlibrary_results.html( '<a href="' + KOHA.OpenLibrary.searchUrl(querystring) + '" target="openlibrary">'  + _("Found %s results in the library's %s collection").format(data.numFound, 'OpenLibrary') + '</a>' );
                        } else {
                            $openlibrary_results.remove();
                        }
                    } );
                [% END # /IF OpenLibrarySearch %]
            [% END # /IF query_desc %]

            [% IF OpenLibraryCovers %]KOHA.OpenLibrary.GetCoverFromIsbn();[% END %]
            [% IF OPACLocalCoverImages %]KOHA.LocalCover.GetCoverFromBibnumber(false);[% END %]
            [% IF ( GoogleJackets ) %]KOHA.Google.GetCoverFromIsbn();[% END %]
            [% IF ( Koha.Preference('OpacCoce') && Koha.Preference('CoceProviders') ) %]
                KOHA.coce.getURL('[% Koha.Preference('CoceHost') | html %]', '[% Koha.Preference('CoceProviders') | html %]');
            [% END %]

            [% IF ( DidYouMean ) %]
                $("#didyoumean").load("/cgi-bin/koha/svc/suggestion?render=stub&q=[% querystring |uri %]",
                    function() {
                        $(this).addClass("dym-loaded");
                    });
            [% END %]

            $("input.newtag").on('keydown', function(e){
                if (e.keyCode == 13) { e.preventDefault(); }
            });
        });
    </script>
[% END %]
